{"version":3,"sources":["public/src/admin/manage/categories.js"],"names":["define","translator","Benchpress","categorySelector","api","Sortable","Categories","newCategoryId","sortables","init","render","ajaxify","data","categories","$","on","throwCreateModal","$this","this","cid","attr","parentEl","parents","disabled","hasClass","childrenEls","find","childrenCids","map","get","toggleClass","translateText","toggle","concat","el","closest","toggleAll","expand","searchCategory","container","revealParents","parentCid","removeClass","revealChildren","els","each","index","$el","categoryEls","val","toLowerCase","noMatch","cids","liEl","isMatch","indexOf","push","forEach","socket","emit","err","app","alertError","message","unshift","name","icon","parse","html","modal","bootbox","dialog","title","buttons","save","label","className","callback","submit","parentSelector","cloneFromSelector","formData","serializeObject","description","uid","user","getSelectedCid","cloneFromCid","create","check","parentSelect","prop","selectCategory","removeAttr","payload","alert","alert_id","type","timeout","go","length","translate","text","addClass","appendTo","renderList","Promise","all","put","itemDidAdd","e","to","dataset","itemDragDidEnd","isCategoryUpdate","parseInt","newIndex","oldIndex","parentCategory","from","modified","i","list","toArray","len","order","item","Object","keys","parentId","count","category","idx","parent","translated","continueRender","append","x","numCategories","children","group","animation","handle","dataIdAttr","ghostClass","onAdd","onEnd"],"mappings":"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","file":"public/src/admin/manage/categories.js","sourcesContent":["'use strict';\n\ndefine('admin/manage/categories', [\n\t'translator',\n\t'benchpress',\n\t'categorySelector',\n\t'api',\n\t'Sortable',\n], function (translator, Benchpress, categorySelector, api, Sortable) {\n\tvar\tCategories = {};\n\tvar newCategoryId = -1;\n\tvar sortables;\n\n\tCategories.init = function () {\n\t\tCategories.render(ajaxify.data.categories);\n\n\t\t$('button[data-action=\"create\"]').on('click', Categories.throwCreateModal);\n\n\t\t// Enable/Disable toggle events\n\t\t$('.categories').on('click', '.category-tools [data-action=\"toggle\"]', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar cid = $this.attr('data-disable-cid');\n\t\t\tvar parentEl = $this.parents('li[data-cid=\"' + cid + '\"]');\n\t\t\tvar disabled = parentEl.hasClass('disabled');\n\t\t\tvar childrenEls = parentEl.find('li[data-cid]');\n\t\t\tvar childrenCids = childrenEls.map(function () {\n\t\t\t\treturn $(this).attr('data-cid');\n\t\t\t}).get();\n\n\t\t\tparentEl.toggleClass('disabled', !disabled);\n\t\t\tchildrenEls.toggleClass('disabled', !disabled);\n\t\t\t$this.translateText(!disabled ? '[[admin/manage/categories:enable]]' : '[[admin/manage/categories:disable]]');\n\t\t\tchildrenEls.find('li a[data-action=\"toggle\"]').translateText(!disabled ? '[[admin/manage/categories:enable]]' : '[[admin/manage/categories:disable]]');\n\n\t\t\tCategories.toggle([cid].concat(childrenCids), !disabled);\n\t\t});\n\n\t\t$('.categories').on('click', '.toggle', function () {\n\t\t\tvar el = $(this);\n\t\t\tel.find('i').toggleClass('fa-minus').toggleClass('fa-plus');\n\t\t\tel.closest('[data-cid]').find('> ul[data-cid]').toggleClass('hidden');\n\t\t});\n\n\t\t$('#collapse-all').on('click', function () {\n\t\t\ttoggleAll(false);\n\t\t});\n\n\t\t$('#expand-all').on('click', function () {\n\t\t\ttoggleAll(true);\n\t\t});\n\n\t\tfunction toggleAll(expand) {\n\t\t\tvar el = $('.categories .toggle');\n\t\t\tel.find('i').toggleClass('fa-minus', expand).toggleClass('fa-plus', !expand);\n\t\t\tel.closest('[data-cid]').find('> ul[data-cid]').toggleClass('hidden', !expand);\n\t\t}\n\n\t\t$('#category-search').on('keyup', function () {\n\t\t\tsearchCategory();\n\t\t});\n\t};\n\n\tfunction searchCategory() {\n\t\tvar container = $('#content .categories');\n\t\tfunction revealParents(cid) {\n\t\t\tvar parentCid = container.find('li[data-cid=\"' + cid + '\"]').attr('data-parent-cid');\n\t\t\tif (parentCid) {\n\t\t\t\tcontainer.find('li[data-cid=\"' + parentCid + '\"]').removeClass('hidden');\n\t\t\t\trevealParents(parentCid);\n\t\t\t}\n\t\t}\n\n\t\tfunction revealChildren(cid) {\n\t\t\tvar els = container.find('li[data-parent-cid=\"' + cid + '\"]');\n\t\t\tels.each(function (index, el) {\n\t\t\t\tvar $el = $(el);\n\t\t\t\t$el.removeClass('hidden');\n\t\t\t\trevealChildren($el.attr('data-cid'));\n\t\t\t});\n\t\t}\n\n\t\tvar categoryEls = container.find('li[data-cid]');\n\t\tvar val = $('#category-search').val().toLowerCase();\n\t\tvar noMatch = true;\n\t\tvar cids = [];\n\t\tcategoryEls.each(function () {\n\t\t\tvar liEl = $(this);\n\t\t\tvar isMatch = liEl.attr('data-name').toLowerCase().indexOf(val) !== -1;\n\t\t\tif (noMatch && isMatch) {\n\t\t\t\tnoMatch = false;\n\t\t\t}\n\t\t\tif (isMatch && val) {\n\t\t\t\tcids.push(liEl.attr('data-cid'));\n\t\t\t}\n\t\t\tliEl.toggleClass('hidden', !isMatch);\n\t\t});\n\n\t\tcids.forEach(function (cid) {\n\t\t\trevealParents(cid);\n\t\t\trevealChildren(cid);\n\t\t});\n\n\t\t$('[component=\"category/no-matches\"]').toggleClass('hidden', !noMatch);\n\t}\n\n\tCategories.throwCreateModal = function () {\n\t\tsocket.emit('categories.getSelectCategories', {}, function (err, categories) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tcategories.unshift({\n\t\t\t\tcid: 0,\n\t\t\t\tname: '[[admin/manage/categories:parent-category-none]]',\n\t\t\t\ticon: 'fa-none',\n\t\t\t});\n\t\t\tBenchpress.parse('admin/partials/categories/create', {\n\t\t\t\tcategories: categories,\n\t\t\t}, function (html) {\n\t\t\t\tvar modal = bootbox.dialog({\n\t\t\t\t\ttitle: '[[admin/manage/categories:alert.create]]',\n\t\t\t\t\tmessage: html,\n\t\t\t\t\tbuttons: {\n\t\t\t\t\t\tsave: {\n\t\t\t\t\t\t\tlabel: '[[global:save]]',\n\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\tvar parentSelector = categorySelector.init(modal.find('#parentCidGroup [component=\"category-selector\"]'));\n\t\t\t\tvar cloneFromSelector = categorySelector.init(modal.find('#cloneFromCidGroup [component=\"category-selector\"]'));\n\t\t\t\tfunction submit() {\n\t\t\t\t\tvar formData = modal.find('form').serializeObject();\n\t\t\t\t\tformData.description = '';\n\t\t\t\t\tformData.icon = 'fa-comments';\n\t\t\t\t\tformData.uid = app.user.uid;\n\t\t\t\t\tformData.parentCid = parentSelector.getSelectedCid();\n\t\t\t\t\tformData.cloneFromCid = cloneFromSelector.getSelectedCid();\n\n\t\t\t\t\tCategories.create(formData);\n\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\t$('#cloneChildren').on('change', function () {\n\t\t\t\t\tvar check = $(this);\n\t\t\t\t\tvar parentSelect = modal.find('#parentCidGroup [component=\"category-selector\"] .dropdown-toggle');\n\n\t\t\t\t\tif (check.prop('checked')) {\n\t\t\t\t\t\tparentSelect.attr('disabled', 'disabled');\n\t\t\t\t\t\tparentSelector.selectCategory(0);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tparentSelect.removeAttr('disabled');\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tmodal.find('form').on('submit', submit);\n\t\t\t});\n\t\t});\n\t};\n\n\tCategories.create = function (payload) {\n\t\tsocket.emit('admin.categories.create', payload, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tapp.alert({\n\t\t\t\talert_id: 'category_created',\n\t\t\t\ttitle: '[[admin/manage/categories:alert.created]]',\n\t\t\t\tmessage: '[[admin/manage/categories:alert.create-success]]',\n\t\t\t\ttype: 'success',\n\t\t\t\ttimeout: 2000,\n\t\t\t});\n\n\t\t\tajaxify.go('admin/manage/categories/' + data.cid);\n\t\t});\n\t};\n\n\tCategories.render = function (categories) {\n\t\tvar container = $('.categories');\n\n\t\tif (!categories || !categories.length) {\n\t\t\ttranslator.translate('[[admin/manage/categories:alert.none-active]]', function (text) {\n\t\t\t\t$('<div></div>')\n\t\t\t\t\t.addClass('alert alert-info text-center')\n\t\t\t\t\t.text(text)\n\t\t\t\t\t.appendTo(container);\n\t\t\t});\n\t\t} else {\n\t\t\tsortables = {};\n\t\t\trenderList(categories, container, 0);\n\t\t}\n\t};\n\n\tCategories.toggle = function (cids, disabled) {\n\t\tPromise.all(cids.map(cid => api.put('/categories/' + cid, {\n\t\t\tdisabled: disabled ? 1 : 0,\n\t\t})));\n\t};\n\n\tfunction itemDidAdd(e) {\n\t\tnewCategoryId = e.to.dataset.cid;\n\t}\n\n\tfunction itemDragDidEnd(e) {\n\t\tvar isCategoryUpdate = parseInt(newCategoryId, 10) !== -1;\n\n\t\t// Update needed?\n\t\tif ((e.newIndex != null && parseInt(e.oldIndex, 10) !== parseInt(e.newIndex, 10)) || isCategoryUpdate) {\n\t\t\tvar parentCategory = isCategoryUpdate ? sortables[newCategoryId] : sortables[e.from.dataset.cid];\n\t\t\tvar modified = {};\n\t\t\tvar i = 0;\n\t\t\tvar list = parentCategory.toArray();\n\t\t\tvar len = list.length;\n\n\t\t\tfor (i; i < len; i += 1) {\n\t\t\t\tmodified[list[i]] = {\n\t\t\t\t\torder: (i + 1),\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (isCategoryUpdate) {\n\t\t\t\tmodified[e.item.dataset.cid].parentCid = newCategoryId;\n\t\t\t}\n\n\t\t\tnewCategoryId = -1;\n\n\t\t\tObject.keys(modified).map(cid => api.put('/categories/' + cid, modified[cid]));\n\t\t}\n\t}\n\n\t/**\n\t * Render categories - recursively\n\t *\n\t * @param categories {array} categories tree\n\t * @param level {number} current sub-level of rendering\n\t * @param container {object} parent jquery element for the list\n\t * @param parentId {number} parent category identifier\n\t */\n\tfunction renderList(categories, container, parentId) {\n\t\t// Translate category names if needed\n\t\tvar count = 0;\n\t\tcategories.forEach(function (category, idx, parent) {\n\t\t\ttranslator.translate(category.name, function (translated) {\n\t\t\t\tif (category.name !== translated) {\n\t\t\t\t\tcategory.name = translated;\n\t\t\t\t}\n\t\t\t\tcount += 1;\n\n\t\t\t\tif (count === parent.length) {\n\t\t\t\t\tcontinueRender();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tif (!categories.length) {\n\t\t\tcontinueRender();\n\t\t}\n\n\t\tfunction continueRender() {\n\t\t\tBenchpress.parse('admin/partials/categories/category-rows', {\n\t\t\t\tcid: parentId,\n\t\t\t\tcategories: categories,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tcontainer.append(html);\n\n\t\t\t\t\t// Handle and children categories in this level have\n\t\t\t\t\tfor (var x = 0, numCategories = categories.length; x < numCategories; x += 1) {\n\t\t\t\t\t\trenderList(categories[x].children, $('li[data-cid=\"' + categories[x].cid + '\"]'), categories[x].cid);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Make list sortable\n\t\t\t\t\tsortables[parentId] = Sortable.create($('ul[data-cid=\"' + parentId + '\"]')[0], {\n\t\t\t\t\t\tgroup: 'cross-categories',\n\t\t\t\t\t\tanimation: 150,\n\t\t\t\t\t\thandle: '.information',\n\t\t\t\t\t\tdataIdAttr: 'data-cid',\n\t\t\t\t\t\tghostClass: 'placeholder',\n\t\t\t\t\t\tonAdd: itemDidAdd,\n\t\t\t\t\t\tonEnd: itemDragDidEnd,\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\treturn Categories;\n});\n"]}