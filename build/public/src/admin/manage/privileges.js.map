{"version":3,"sources":["public/src/admin/manage/privileges.js"],"names":["define","autocomplete","translator","Benchpress","categorySelector","mousetrap","Privileges","cid","init","isNaN","parseInt","ajaxify","data","selectedCategory","$","category","refreshPrivilegeTable","updateHistory","setupPrivilegeTable","highlightRow","on","checkboxEl","this","wrapperEl","parent","privilege","attr","state","prop","rowEl","parents","member","isPrivate","isGroup","undefined","delta","bootbox","confirm","exposeAssumedPrivileges","app","alertError","addEvents","document","getElementById","addEventListener","throwConfirmModal","commit","discard","addUserToPrivilegeTable","addGroupToPrivilegeTable","copyPrivilegesToChildren","bind","groupName","copyPrivilegesFromCategory","copyPrivilegesToAllCategories","ev","preventDefault","method","onConfirm","ok","call","tableEl","querySelector","requests","map","querySelectorAll","el","getAttribute","parentNode","setPrivilege","Promise","allSettled","then","alertSuccess","groupToHighlight","socket","emit","err","privileges","message","tpl","parse","html","translate","hightlightRowByDataAttr","privs","each","idx","find","push","concat","priv","startsWith","slice","filter","Boolean","x","numPrivs","length","inputs","checked","indeterminate","resolve","reject","set","modal","dialog","title","show","inputEl","focus","user","ui","addUserToCategory","item","group","name","alert","type","addGroupToCategory","categories","fromCid","toCid","refresh","attrName","attrValue","String","addClass","cb","groupRow","privilegeSet","keys","groups","reduce","memo","cur","parseAndTranslate","nameEscaped","escape","rows","insertBefore","userRow","uid","users","picture","username","icon:text","icon:bgColor"],"mappings":"AAAA,aAEAA,OAAO,2BACN,eACA,aACA,aACA,mBACA,aACE,SAAUC,EAAcC,EAAYC,EAAYC,EAAkBC,GACpE,IAAIC,KAEJ,IAAIC,EAEJD,EAAWE,KAAO,WACjBD,EAAME,MAAMC,SAASC,QAAQC,KAAKC,iBAAiBN,IAAK,KAAO,QAAUI,QAAQC,KAAKC,iBAAiBN,IAEvGH,EAAiBI,KAAKM,EAAE,mCAAoC,SAAUC,GACrER,EAAMG,SAASK,EAASR,IAAK,IAC7BA,EAAME,MAAMF,GAAO,QAAUA,EAC7BD,EAAWU,wBACXL,QAAQM,cAAc,4BAA8BV,GAAO,OAG5DD,EAAWY,sBAEXC,KAGDb,EAAWY,oBAAsB,WAChCJ,EAAE,8BAA8BM,GAAG,SAAU,yBAA0B,WACtE,IAAIC,EAAaP,EAAEQ,MACnB,IAAIC,EAAYF,EAAWG,SAC3B,IAAIC,EAAYF,EAAUG,KAAK,kBAC/B,IAAIC,EAAQN,EAAWO,KAAK,WAC5B,IAAIC,EAAQR,EAAWS,QAAQ,MAC/B,IAAIC,EAASF,EAAMH,KAAK,oBAAsBG,EAAMH,KAAK,YACzD,IAAIM,EAAYtB,SAASmB,EAAMH,KAAK,iBAAmB,EAAG,IAC1D,IAAIO,EAAUJ,EAAMH,KAAK,qBAAuBQ,UAChD,IAAIC,EAAQd,EAAWO,KAAK,cAAgBL,EAAUG,KAAK,gBAAkB,QAAU,KAAOC,EAE9F,GAAII,EAAQ,CACX,GAAIE,GAAWR,IAAc,oBAAsBO,GAAaL,EAAO,CACtES,QAAQC,QAAQ,qDAAsD,SAAUA,GAC/E,GAAIA,EAAS,CACZd,EAAUG,KAAK,aAAcS,GAC7B7B,EAAWgC,8BACL,CACNjB,EAAWO,KAAK,WAAYP,EAAWO,KAAK,mBAGxC,CACNL,EAAUG,KAAK,aAAcS,GAC7B7B,EAAWgC,+BAEN,CACNC,IAAIC,WAAW,6BAIjBlC,EAAWgC,0BACXhC,EAAWmC,aAGZnC,EAAWmC,UAAY,WACtBC,SAASC,eAAe,QAAQC,iBAAiB,QAAS,WACzDC,EAAkB,OAAQvC,EAAWwC,UAGtCJ,SAASC,eAAe,WAAWC,iBAAiB,QAAS,WAC5DC,EAAkB,UAAWvC,EAAWyC,WAGzCjC,EAAE,8BAA8BM,GAAG,QAAS,8BAA+Bd,EAAW0C,yBACtFlC,EAAE,8BAA8BM,GAAG,QAAS,+BAAgCd,EAAW2C,0BACvFnC,EAAE,8BAA8BM,GAAG,QAAS,iCAAkC,WAC7EyB,EAAkB,iBAAkBvC,EAAW4C,yBAAyBC,KAAK,KAAM5C,EAAK,OAEzFO,EAAE,8BAA8BM,GAAG,QAAS,sCAAuC,WAClF,IAAIgC,EAAYtC,EAAEQ,MAAMQ,QAAQ,qBAAqBJ,KAAK,mBAC1DmB,EAAkB,sBAAuBvC,EAAW4C,yBAAyBC,KAAK,KAAM5C,EAAK6C,MAG9FtC,EAAE,8BAA8BM,GAAG,QAAS,qCAAsC,WACjFd,EAAW+C,2BAA2B9C,EAAK,MAE5CO,EAAE,8BAA8BM,GAAG,QAAS,0CAA2C,WACtF,IAAIgC,EAAYtC,EAAEQ,MAAMQ,QAAQ,qBAAqBJ,KAAK,mBAC1DpB,EAAW+C,2BAA2B9C,EAAK6C,KAG5CtC,EAAE,8BAA8BM,GAAG,QAAS,4BAA6B,WACxEyB,EAAkB,YAAavC,EAAWgD,8BAA8BH,KAAK,KAAM5C,EAAK,OAEzFO,EAAE,8BAA8BM,GAAG,QAAS,iCAAkC,WAC7E,IAAIgC,EAAYtC,EAAEQ,MAAMQ,QAAQ,qBAAqBJ,KAAK,mBAC1DmB,EAAkB,iBAAkBvC,EAAWgD,8BAA8BH,KAAK,KAAM5C,EAAK6C,MAG9F/C,EAAU8C,KAAK,SAAU,SAAUI,GAClCV,EAAkB,OAAQvC,EAAWwC,QACrCS,EAAGC,mBAGJ,SAASX,EAAkBY,EAAQC,GAClCtB,QAAQC,QAAQ,2CAA6CoB,EAAS,0DAA2D,SAAUE,GAC1I,GAAIA,EAAI,CACPD,EAAUE,YAMdtD,EAAWwC,OAAS,WACnB,IAAIe,EAAUnB,SAASoB,cAAc,8BACrC,IAAIC,EAAWjD,EAAEkD,IAAIH,EAAQI,iBAAiB,kBAAmB,SAAUC,GAC1E,IAAIzC,EAAYyC,EAAGC,aAAa,kBAChC,IAAItC,EAAQqC,EAAGE,WACf,IAAIrC,EAASF,EAAMsC,aAAa,oBAAsBtC,EAAMsC,aAAa,YACzE,IAAIxC,EAAQuC,EAAGC,aAAa,gBAAkB,OAAS,EAAI,EAE3D,OAAO7D,EAAW+D,aAAatC,EAAQN,EAAWE,KAGnD2C,QAAQC,WAAWR,GAAUS,KAAK,WACjClE,EAAWU,wBACXuB,IAAIkC,aAAa,8CAInBnE,EAAWyC,QAAU,WACpBzC,EAAWU,wBACXuB,IAAIkC,aAAa,gDAGlBnE,EAAWU,sBAAwB,SAAU0D,GAC5CC,OAAOC,KAAK,wCAAyCrE,EAAK,SAAUsE,EAAKC,GACxE,GAAID,EAAK,CACR,OAAOtC,IAAIC,WAAWqC,EAAIE,SAG3BpE,QAAQC,KAAKkE,WAAaA,EAC1B,IAAIE,EAAMtE,SAASH,EAAK,IAAM,qCAAuC,mCACrEJ,EAAW8E,MAAMD,GAChBF,WAAYA,GACV,SAAUI,GACZhF,EAAWiF,UAAUD,EAAM,SAAUA,GACpCpE,EAAE,8BAA8BoE,KAAKA,GACrC5E,EAAWgC,0BAEX8C,EAAwB,kBAAmBV,UAM/CpE,EAAWgC,wBAA0B,WAMpC,IAAI+C,KACJvE,EAAE,qFAAqFU,SAAS8D,KAAK,SAAUC,EAAKrB,GACnH,GAAIpD,EAAEoD,GAAIsB,KAAK,SAAS5D,KAAK,WAAY,CACxCyD,EAAMI,KAAKvB,EAAGC,aAAa,sBAK7BkB,EAAQA,EAAMK,OAAOL,EAAMrB,IAAI,SAAU2B,GACxC,GAAIA,EAAKC,WAAW,WAAY,CAC/B,OAAOD,EAAKE,MAAM,GAGnB,OAAO,SACJC,OAAOC,SAEX,IAAK,IAAIC,EAAI,EAAGC,EAAWZ,EAAMa,OAAQF,EAAIC,EAAUD,GAAK,EAAG,CAC9D,IAAIG,EAASrF,EAAE,4JAA8JuE,EAAMW,GAAK,8DAAgEX,EAAMW,GAAK,YACnQG,EAAOb,KAAK,SAAUC,EAAKrB,GAC1B,IAAKA,EAAGkC,QAAS,CAChBlC,EAAGmC,cAAgB,UAMvB/F,EAAW+D,aAAe,SAAUtC,EAAQN,EAAWE,GACtD,OAAO,IAAI2C,QAAQ,SAAUgC,EAASC,GACrC5B,OAAOC,KAAK,iCACXrE,IAAKE,MAAMF,GAAO,EAAIA,EACtBkB,UAAWA,EACX+E,IAAK7E,EACLI,OAAQA,GACN,SAAU8C,GACZ,GAAIA,EAAK,CACR0B,EAAO1B,GACP,OAAOtC,IAAIC,WAAWqC,EAAIE,SAG3BuB,SAKHhG,EAAW0C,wBAA0B,WACpC,IAAIyD,EAAQrE,QAAQsE,QACnBC,MAAO,8CACP5B,QAAS,sGACT6B,KAAM,OAGPH,EAAMrF,GAAG,iBAAkB,WAC1B,IAAIyF,EAAUJ,EAAMjB,KAAK,SACzBqB,EAAQC,QAER7G,EAAa8G,KAAKF,EAAS,SAAUtD,EAAIyD,GACxCC,EAAkBD,EAAGE,KAAKH,KAAM,WAC/BN,EAAMA,MAAM,eAMhBnG,EAAW2C,yBAA2B,WACrC,IAAIwD,EAAQrE,QAAQsE,QACnBC,MAAO,+CACP5B,QAAS,uGACT6B,KAAM,OAGPH,EAAMrF,GAAG,iBAAkB,WAC1B,IAAIyF,EAAUJ,EAAMjB,KAAK,SACzBqB,EAAQC,QAER7G,EAAakH,MAAMN,EAAS,SAAUtD,EAAIyD,GACzC,GAAIA,EAAGE,KAAKC,MAAMC,OAAS,iBAAkB,CAC5C,OAAO7E,IAAI8E,OACVC,KAAM,UACNvC,QAAS,oDAGXwC,EAAmBP,EAAGE,KAAKC,MAAMC,KAAM,WACtCX,EAAMA,MAAM,eAMhBnG,EAAW4C,yBAA2B,SAAU3C,EAAK4G,GACpDxC,OAAOC,KAAK,6CAA+CrE,IAAKA,EAAK4G,MAAOA,GAAS,SAAUtC,GAC9F,GAAIA,EAAK,CACR,OAAOtC,IAAIC,WAAWqC,EAAIE,SAE3BxC,IAAIkC,aAAa,0DAInBnE,EAAW+C,2BAA6B,SAAU9C,EAAK4G,GACtD/G,EAAiBqG,MAAM9F,QAAQC,KAAK4G,WAAW3B,MAAM,GAAI,SAAU4B,GAClE9C,OAAOC,KAAK,uCAAyC8C,MAAOnH,EAAKkH,QAASA,EAASN,MAAOA,GAAS,SAAUtC,GAC5G,GAAIA,EAAK,CACR,OAAOtC,IAAIC,WAAWqC,EAAIE,SAE3BpE,QAAQgH,eAKXrH,EAAWgD,8BAAgC,SAAU/C,EAAK4G,GACzDxC,OAAOC,KAAK,kDAAoDrE,IAAKA,EAAK4G,MAAOA,GAAS,SAAUtC,GACnG,GAAIA,EAAK,CACR,OAAOtC,IAAIC,WAAWqC,EAAIE,SAE3BxC,IAAIkC,aAAa,0DAInB,SAASW,EAAwBwC,EAAUC,GAC1C,GAAIA,EAAW,CACd,IAAI3D,EAAKpD,EAAE,IAAM8G,EAAW,KAAK9B,OAAO,WACvC,OAAOhF,EAAEQ,MAAMI,KAAKkG,KAAcE,OAAOD,KAG1C,GAAI3D,EAAGgC,OAAQ,CACdhC,EAAG6D,SAAS,YACZ,OAAO,MAGT,OAAO,MAGR,SAAS5G,IACR,GAAIR,QAAQC,KAAKuG,MAAO,CACvB,GAAI/B,EAAwB,kBAAmBzE,QAAQC,KAAKuG,OAAQ,CACnE,OAEDI,EAAmB5G,QAAQC,KAAKuG,QAIlC,SAASI,EAAmBJ,EAAOa,GAClCA,EAAKA,GAAM,aACX,IAAIC,EAAWvF,SAASoB,cAAc,sCAAwCqD,EAAQ,MACtF,GAAIc,EAAU,CACb7C,EAAwB,kBAAmB+B,GAC3C,OAAOa,IAGR,IAAIE,EAAevH,QAAQC,KAAKkE,WAAWqD,KAAKC,OAAOC,OAAO,SAAUC,EAAMC,GAC7ED,EAAKC,GAAO,MACZ,OAAOD,OAGR/F,IAAIiG,kBAAkB,8BAAiC/H,MAAMF,IAAQA,IAAQ,EAAK,SAAW,YAAa,qBACzGuE,YACCsD,SAEEhB,KAAMD,EACNsB,YAAavI,EAAWwI,OAAOvB,GAC/BrC,WAAYoD,MAIb,SAAUhD,GACZ,IAAIrB,EAAUnB,SAASoB,cAAc,oBACrC,IAAI6E,EAAO9E,EAAQI,iBAAiB,YACpCiB,EAAK0D,aAAaD,EAAKA,EAAKzC,OAAS,IACrC5F,EAAWgC,0BACX8C,EAAwB,kBAAmB+B,GAC3Ca,MAIF,SAASf,EAAkBF,EAAMiB,GAChCA,EAAKA,GAAM,aACX,IAAIa,EAAUnG,SAASoB,cAAc,+BAAiCiD,EAAK+B,IAAM,MACjF,GAAID,EAAS,CACZzD,EAAwB,WAAY2B,EAAK+B,KACzC,OAAOd,IAGR,IAAIE,EAAevH,QAAQC,KAAKkE,WAAWqD,KAAKY,MAAMV,OAAO,SAAUC,EAAMC,GAC5ED,EAAKC,GAAO,MACZ,OAAOD,OAGR/F,IAAIiG,kBAAkB,8BAAgC/H,MAAMF,GAAO,SAAW,YAAa,oBAC1FuE,YACCiE,QAEEC,QAASjC,EAAKiC,QACdC,SAAUlC,EAAKkC,SACfH,IAAK/B,EAAK+B,IACVI,YAAanC,EAAK,aAClBoC,eAAgBpC,EAAK,gBACrBjC,WAAYoD,MAIb,SAAUhD,GACZ,IAAIrB,EAAUnB,SAASuB,iBAAiB,oBACxC,IAAI0E,EAAO9E,EAAQ,GAAGI,iBAAiB,YACvCiB,EAAK0D,aAAaD,EAAKA,EAAKzC,OAAS,IACrCd,EAAwB,WAAY2B,EAAK+B,KACzCd,MAIF,OAAO1H","file":"public/src/admin/manage/privileges.js","sourcesContent":["'use strict';\n\ndefine('admin/manage/privileges', [\n\t'autocomplete',\n\t'translator',\n\t'benchpress',\n\t'categorySelector',\n\t'mousetrap',\n], function (autocomplete, translator, Benchpress, categorySelector, mousetrap) {\n\tvar Privileges = {};\n\n\tvar cid;\n\n\tPrivileges.init = function () {\n\t\tcid = isNaN(parseInt(ajaxify.data.selectedCategory.cid, 10)) ? 'admin' : ajaxify.data.selectedCategory.cid;\n\n\t\tcategorySelector.init($('[component=\"category-selector\"]'), function (category) {\n\t\t\tcid = parseInt(category.cid, 10);\n\t\t\tcid = isNaN(cid) ? 'admin' : cid;\n\t\t\tPrivileges.refreshPrivilegeTable();\n\t\t\tajaxify.updateHistory('admin/manage/privileges/' + (cid || ''));\n\t\t});\n\n\t\tPrivileges.setupPrivilegeTable();\n\n\t\thighlightRow();\n\t};\n\n\tPrivileges.setupPrivilegeTable = function () {\n\t\t$('.privilege-table-container').on('change', 'input[type=\"checkbox\"]', function () {\n\t\t\tvar checkboxEl = $(this);\n\t\t\tvar wrapperEl = checkboxEl.parent();\n\t\t\tvar privilege = wrapperEl.attr('data-privilege');\n\t\t\tvar state = checkboxEl.prop('checked');\n\t\t\tvar rowEl = checkboxEl.parents('tr');\n\t\t\tvar member = rowEl.attr('data-group-name') || rowEl.attr('data-uid');\n\t\t\tvar isPrivate = parseInt(rowEl.attr('data-private') || 0, 10);\n\t\t\tvar isGroup = rowEl.attr('data-group-name') !== undefined;\n\t\t\tvar delta = checkboxEl.prop('checked') === (wrapperEl.attr('data-value') === 'true') ? null : state;\n\n\t\t\tif (member) {\n\t\t\t\tif (isGroup && privilege === 'groups:moderate' && !isPrivate && state) {\n\t\t\t\t\tbootbox.confirm('[[admin/manage/privileges:alert.confirm-moderate]]', function (confirm) {\n\t\t\t\t\t\tif (confirm) {\n\t\t\t\t\t\t\twrapperEl.attr('data-delta', delta);\n\t\t\t\t\t\t\tPrivileges.exposeAssumedPrivileges();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcheckboxEl.prop('checked', !checkboxEl.prop('checked'));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\twrapperEl.attr('data-delta', delta);\n\t\t\t\t\tPrivileges.exposeAssumedPrivileges();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tapp.alertError('[[error:invalid-data]]');\n\t\t\t}\n\t\t});\n\n\t\tPrivileges.exposeAssumedPrivileges();\n\t\tPrivileges.addEvents();\t// events with confirmation modals\n\t};\n\n\tPrivileges.addEvents = function () {\n\t\tdocument.getElementById('save').addEventListener('click', function () {\n\t\t\tthrowConfirmModal('save', Privileges.commit);\n\t\t});\n\n\t\tdocument.getElementById('discard').addEventListener('click', function () {\n\t\t\tthrowConfirmModal('discard', Privileges.discard);\n\t\t});\n\n\t\t$('.privilege-table-container').on('click', '[data-action=\"search.user\"]', Privileges.addUserToPrivilegeTable);\n\t\t$('.privilege-table-container').on('click', '[data-action=\"search.group\"]', Privileges.addGroupToPrivilegeTable);\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToChildren\"]', function () {\n\t\t\tthrowConfirmModal('copyToChildren', Privileges.copyPrivilegesToChildren.bind(null, cid, ''));\n\t\t});\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToChildrenGroup\"]', function () {\n\t\t\tvar groupName = $(this).parents('[data-group-name]').attr('data-group-name');\n\t\t\tthrowConfirmModal('copyToChildrenGroup', Privileges.copyPrivilegesToChildren.bind(null, cid, groupName));\n\t\t});\n\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyPrivilegesFrom\"]', function () {\n\t\t\tPrivileges.copyPrivilegesFromCategory(cid, '');\n\t\t});\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyPrivilegesFromGroup\"]', function () {\n\t\t\tvar groupName = $(this).parents('[data-group-name]').attr('data-group-name');\n\t\t\tPrivileges.copyPrivilegesFromCategory(cid, groupName);\n\t\t});\n\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToAll\"]', function () {\n\t\t\tthrowConfirmModal('copyToAll', Privileges.copyPrivilegesToAllCategories.bind(null, cid, ''));\n\t\t});\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToAllGroup\"]', function () {\n\t\t\tvar groupName = $(this).parents('[data-group-name]').attr('data-group-name');\n\t\t\tthrowConfirmModal('copyToAllGroup', Privileges.copyPrivilegesToAllCategories.bind(null, cid, groupName));\n\t\t});\n\n\t\tmousetrap.bind('ctrl+s', function (ev) {\n\t\t\tthrowConfirmModal('save', Privileges.commit);\n\t\t\tev.preventDefault();\n\t\t});\n\n\t\tfunction throwConfirmModal(method, onConfirm) {\n\t\t\tbootbox.confirm('[[admin/manage/privileges:alert.confirm-' + method + ']]<br /><br />[[admin/manage/privileges:alert.no-undo]]', function (ok) {\n\t\t\t\tif (ok) {\n\t\t\t\t\tonConfirm.call();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tPrivileges.commit = function () {\n\t\tvar tableEl = document.querySelector('.privilege-table-container');\n\t\tvar requests = $.map(tableEl.querySelectorAll('td[data-delta]'), function (el) {\n\t\t\tvar privilege = el.getAttribute('data-privilege');\n\t\t\tvar rowEl = el.parentNode;\n\t\t\tvar member = rowEl.getAttribute('data-group-name') || rowEl.getAttribute('data-uid');\n\t\t\tvar state = el.getAttribute('data-delta') === 'true' ? 1 : 0;\n\n\t\t\treturn Privileges.setPrivilege(member, privilege, state);\n\t\t});\n\n\t\tPromise.allSettled(requests).then(function () {\n\t\t\tPrivileges.refreshPrivilegeTable();\n\t\t\tapp.alertSuccess('[[admin/manage/privileges:alert.saved]]');\n\t\t});\n\t};\n\n\tPrivileges.discard = function () {\n\t\tPrivileges.refreshPrivilegeTable();\n\t\tapp.alertSuccess('[[admin/manage/privileges:alert.discarded]]');\n\t};\n\n\tPrivileges.refreshPrivilegeTable = function (groupToHighlight) {\n\t\tsocket.emit('admin.categories.getPrivilegeSettings', cid, function (err, privileges) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tajaxify.data.privileges = privileges;\n\t\t\tvar tpl = parseInt(cid, 10) ? 'admin/partials/privileges/category' : 'admin/partials/privileges/global';\n\t\t\tBenchpress.parse(tpl, {\n\t\t\t\tprivileges: privileges,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\t$('.privilege-table-container').html(html);\n\t\t\t\t\tPrivileges.exposeAssumedPrivileges();\n\n\t\t\t\t\thightlightRowByDataAttr('data-group-name', groupToHighlight);\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tPrivileges.exposeAssumedPrivileges = function () {\n\t\t/*\n\t\t\tIf registered-users has a privilege enabled, then all users and groups of that privilege\n\t\t\tshould be assumed to have that privilege as well, even if not set in the db, so reflect\n\t\t\tthis arrangement in the table\n\t\t*/\n\t\tvar privs = [];\n\t\t$('.privilege-table tr[data-group-name=\"registered-users\"] td input[type=\"checkbox\"]').parent().each(function (idx, el) {\n\t\t\tif ($(el).find('input').prop('checked')) {\n\t\t\t\tprivs.push(el.getAttribute('data-privilege'));\n\t\t\t}\n\t\t});\n\n\t\t// Also apply to non-group privileges\n\t\tprivs = privs.concat(privs.map(function (priv) {\n\t\t\tif (priv.startsWith('groups:')) {\n\t\t\t\treturn priv.slice(7);\n\t\t\t}\n\n\t\t\treturn false;\n\t\t})).filter(Boolean);\n\n\t\tfor (var x = 0, numPrivs = privs.length; x < numPrivs; x += 1) {\n\t\t\tvar inputs = $('.privilege-table tr[data-group-name]:not([data-group-name=\"registered-users\"],[data-group-name=\"guests\"],[data-group-name=\"spiders\"]) td[data-privilege=\"' + privs[x] + '\"] input, .privilege-table tr[data-uid] td[data-privilege=\"' + privs[x] + '\"] input');\n\t\t\tinputs.each(function (idx, el) {\n\t\t\t\tif (!el.checked) {\n\t\t\t\t\tel.indeterminate = true;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tPrivileges.setPrivilege = function (member, privilege, state) {\n\t\treturn new Promise(function (resolve, reject) {\n\t\t\tsocket.emit('admin.categories.setPrivilege', {\n\t\t\t\tcid: isNaN(cid) ? 0 : cid,\n\t\t\t\tprivilege: privilege,\n\t\t\t\tset: state,\n\t\t\t\tmember: member,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treject(err);\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t};\n\n\tPrivileges.addUserToPrivilegeTable = function () {\n\t\tvar modal = bootbox.dialog({\n\t\t\ttitle: '[[admin/manage/categories:alert.find-user]]',\n\t\t\tmessage: '<input class=\"form-control input-lg\" placeholder=\"[[admin/manage/categories:alert.user-search]]\" />',\n\t\t\tshow: true,\n\t\t});\n\n\t\tmodal.on('shown.bs.modal', function () {\n\t\t\tvar inputEl = modal.find('input');\n\t\t\tinputEl.focus();\n\n\t\t\tautocomplete.user(inputEl, function (ev, ui) {\n\t\t\t\taddUserToCategory(ui.item.user, function () {\n\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tPrivileges.addGroupToPrivilegeTable = function () {\n\t\tvar modal = bootbox.dialog({\n\t\t\ttitle: '[[admin/manage/categories:alert.find-group]]',\n\t\t\tmessage: '<input class=\"form-control input-lg\" placeholder=\"[[admin/manage/categories:alert.group-search]]\" />',\n\t\t\tshow: true,\n\t\t});\n\n\t\tmodal.on('shown.bs.modal', function () {\n\t\t\tvar inputEl = modal.find('input');\n\t\t\tinputEl.focus();\n\n\t\t\tautocomplete.group(inputEl, function (ev, ui) {\n\t\t\t\tif (ui.item.group.name === 'administrators') {\n\t\t\t\t\treturn app.alert({\n\t\t\t\t\t\ttype: 'warning',\n\t\t\t\t\t\tmessage: '[[admin/manage/privileges:alert.admin-warning]]',\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\taddGroupToCategory(ui.item.group.name, function () {\n\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tPrivileges.copyPrivilegesToChildren = function (cid, group) {\n\t\tsocket.emit('admin.categories.copyPrivilegesToChildren', { cid: cid, group: group }, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tapp.alertSuccess('[[admin/manage/categories:privileges.copy-success]]');\n\t\t});\n\t};\n\n\tPrivileges.copyPrivilegesFromCategory = function (cid, group) {\n\t\tcategorySelector.modal(ajaxify.data.categories.slice(1), function (fromCid) {\n\t\t\tsocket.emit('admin.categories.copyPrivilegesFrom', { toCid: cid, fromCid: fromCid, group: group }, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tajaxify.refresh();\n\t\t\t});\n\t\t});\n\t};\n\n\tPrivileges.copyPrivilegesToAllCategories = function (cid, group) {\n\t\tsocket.emit('admin.categories.copyPrivilegesToAllCategories', { cid: cid, group: group }, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tapp.alertSuccess('[[admin/manage/categories:privileges.copy-success]]');\n\t\t});\n\t};\n\n\tfunction hightlightRowByDataAttr(attrName, attrValue) {\n\t\tif (attrValue) {\n\t\t\tvar el = $('[' + attrName + ']').filter(function () {\n\t\t\t\treturn $(this).attr(attrName) === String(attrValue);\n\t\t\t});\n\n\t\t\tif (el.length) {\n\t\t\t\tel.addClass('selected');\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tfunction highlightRow() {\n\t\tif (ajaxify.data.group) {\n\t\t\tif (hightlightRowByDataAttr('data-group-name', ajaxify.data.group)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\taddGroupToCategory(ajaxify.data.group);\n\t\t}\n\t}\n\n\tfunction addGroupToCategory(group, cb) {\n\t\tcb = cb || function () {};\n\t\tvar groupRow = document.querySelector('.privilege-table [data-group-name=\"' + group + '\"]');\n\t\tif (groupRow) {\n\t\t\thightlightRowByDataAttr('data-group-name', group);\n\t\t\treturn cb();\n\t\t}\n\t\t// Generate data for new row\n\t\tvar privilegeSet = ajaxify.data.privileges.keys.groups.reduce(function (memo, cur) {\n\t\t\tmemo[cur] = false;\n\t\t\treturn memo;\n\t\t}, {});\n\n\t\tapp.parseAndTranslate('admin/partials/privileges/' + ((isNaN(cid) || cid === 0) ? 'global' : 'category'), 'privileges.groups', {\n\t\t\tprivileges: {\n\t\t\t\tgroups: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: group,\n\t\t\t\t\t\tnameEscaped: translator.escape(group),\n\t\t\t\t\t\tprivileges: privilegeSet,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t}, function (html) {\n\t\t\tvar tableEl = document.querySelector('.privilege-table');\n\t\t\tvar rows = tableEl.querySelectorAll('tbody tr');\n\t\t\thtml.insertBefore(rows[rows.length - 1]);\n\t\t\tPrivileges.exposeAssumedPrivileges();\n\t\t\thightlightRowByDataAttr('data-group-name', group);\n\t\t\tcb();\n\t\t});\n\t}\n\n\tfunction addUserToCategory(user, cb) {\n\t\tcb = cb || function () {};\n\t\tvar userRow = document.querySelector('.privilege-table [data-uid=\"' + user.uid + '\"]');\n\t\tif (userRow) {\n\t\t\thightlightRowByDataAttr('data-uid', user.uid);\n\t\t\treturn cb();\n\t\t}\n\t\t// Generate data for new row\n\t\tvar privilegeSet = ajaxify.data.privileges.keys.users.reduce(function (memo, cur) {\n\t\t\tmemo[cur] = false;\n\t\t\treturn memo;\n\t\t}, {});\n\n\t\tapp.parseAndTranslate('admin/partials/privileges/' + (isNaN(cid) ? 'global' : 'category'), 'privileges.users', {\n\t\t\tprivileges: {\n\t\t\t\tusers: [\n\t\t\t\t\t{\n\t\t\t\t\t\tpicture: user.picture,\n\t\t\t\t\t\tusername: user.username,\n\t\t\t\t\t\tuid: user.uid,\n\t\t\t\t\t\t'icon:text': user['icon:text'],\n\t\t\t\t\t\t'icon:bgColor': user['icon:bgColor'],\n\t\t\t\t\t\tprivileges: privilegeSet,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t}, function (html) {\n\t\t\tvar tableEl = document.querySelectorAll('.privilege-table');\n\t\t\tvar rows = tableEl[1].querySelectorAll('tbody tr');\n\t\t\thtml.insertBefore(rows[rows.length - 1]);\n\t\t\thightlightRowByDataAttr('data-uid', user.uid);\n\t\t\tcb();\n\t\t});\n\t}\n\n\treturn Privileges;\n});\n"]}