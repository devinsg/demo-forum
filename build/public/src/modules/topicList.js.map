{"version":3,"sources":["public/src/modules/topicList.js"],"names":["define","infinitescroll","handleBack","topicSelect","categoryFilter","categoryTools","TopicList","templateName","tplToSort","recent","unread","popular","top","newTopicCount","newPostCount","loadTopicsCallback","topicListEl","$","window","on","removeListeners","init","template","cb","findTopicListElement","loadTopicsAfter","watchForNewPosts","config","usePagination","loadMoreTopics","after","handleBackCallback","data","loadCallback","onTopicsLoaded","topics","ajaxify","showSelect","height","children","length","show","trigger","filter","i","e","parents","this","addClass","socket","onNewTopic","onNewPost","removeListener","isCategoryVisible","cid","categories","some","c","parseInt","selectedCids","indexOf","selectedFilter","category","updateAlertText","post","posts","topic","isFollowing","mainPid","pid","text","translateText","removeClass","fadeIn","direction","find","afterEl","last","first","attr","utils","isNumber","done","callback","query","params","loadMore","sort","count","topicsPerPage","term","selectedTerm","set","filterTopicsOnDom","tid","hide","before","topicEls","tplData","name","app","parseAndTranslate","html","remove","insertAfter","document","scrollTop","insertBefore","append","getSelectedTids","removeExtra","timeago","createUserTooltips","makeNumbersHumanReadable"],"mappings":"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","file":"public/src/modules/topicList.js","sourcesContent":["'use strict';\n\ndefine('topicList', [\n\t'forum/infinitescroll',\n\t'handleBack',\n\t'topicSelect',\n\t'categoryFilter',\n\t'forum/category/tools',\n], function (infinitescroll, handleBack, topicSelect, categoryFilter, categoryTools) {\n\tvar TopicList = {};\n\tvar templateName = '';\n\n\tvar tplToSort = {\n\t\trecent: 'recent',\n\t\tunread: 'unread',\n\t\tpopular: 'posts',\n\t\ttop: 'votes',\n\t};\n\n\tvar newTopicCount = 0;\n\tvar newPostCount = 0;\n\n\tvar loadTopicsCallback;\n\tvar topicListEl;\n\n\t$(window).on('action:ajaxify.start', function () {\n\t\tTopicList.removeListeners();\n\t\tcategoryTools.removeListeners();\n\t});\n\n\tTopicList.init = function (template, cb) {\n\t\ttopicListEl = findTopicListElement();\n\n\t\ttemplateName = template;\n\t\tloadTopicsCallback = cb || loadTopicsAfter;\n\n\t\tcategoryTools.init();\n\n\t\tTopicList.watchForNewPosts();\n\n\t\tcategoryFilter.init($('[component=\"category/dropdown\"]'));\n\n\t\tif (!config.usePagination) {\n\t\t\tinfinitescroll.init(TopicList.loadMoreTopics);\n\t\t}\n\n\t\thandleBack.init(function (after, handleBackCallback) {\n\t\t\tloadTopicsCallback(after, 1, function (data, loadCallback) {\n\t\t\t\tTopicList.onTopicsLoaded(templateName, data.topics, ajaxify.data.showSelect, 1, function () {\n\t\t\t\t\thandleBackCallback();\n\t\t\t\t\tloadCallback();\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tif ($('body').height() <= $(window).height() && topicListEl.children().length >= 20) {\n\t\t\t$('#load-more-btn').show();\n\t\t}\n\n\t\t$('#load-more-btn').on('click', function () {\n\t\t\tTopicList.loadMoreTopics(1);\n\t\t});\n\n\t\t$(window).trigger('action:topics.loaded', { topics: ajaxify.data.topics });\n\t};\n\n\tfunction findTopicListElement() {\n\t\treturn $('[component=\"category\"]').filter(function (i, e) {\n\t\t\treturn !$(e).parents('[widget-area],[data-widget-area]').length;\n\t\t});\n\t}\n\n\tTopicList.watchForNewPosts = function () {\n\t\t$('#new-topics-alert').on('click', function () {\n\t\t\t$(this).addClass('hide');\n\t\t});\n\t\tnewPostCount = 0;\n\t\tnewTopicCount = 0;\n\t\tTopicList.removeListeners();\n\t\tsocket.on('event:new_topic', onNewTopic);\n\t\tsocket.on('event:new_post', onNewPost);\n\t};\n\n\tTopicList.removeListeners = function () {\n\t\tsocket.removeListener('event:new_topic', onNewTopic);\n\t\tsocket.removeListener('event:new_post', onNewPost);\n\t};\n\n\tfunction isCategoryVisible(cid) {\n\t\treturn ajaxify.data.categories && ajaxify.data.categories.length && ajaxify.data.categories.some(function (c) {\n\t\t\treturn parseInt(c.cid, 10) === parseInt(cid, 10);\n\t\t});\n\t}\n\n\tfunction onNewTopic(data) {\n\t\tif (\n\t\t\t(ajaxify.data.selectedCids && ajaxify.data.selectedCids.length && ajaxify.data.selectedCids.indexOf(parseInt(data.cid, 10)) === -1) ||\n\t\t\t(ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'watched') ||\n\t\t\t(ajaxify.data.template.category && parseInt(ajaxify.data.cid, 10) !== parseInt(data.cid, 10)) ||\n\t\t\t(!isCategoryVisible(data.cid))\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tnewTopicCount += 1;\n\t\tupdateAlertText();\n\t}\n\n\tfunction onNewPost(data) {\n\t\tvar post = data.posts[0];\n\t\tif (!post || !post.topic) {\n\t\t\treturn;\n\t\t}\n\t\tif (!post.topic.isFollowing && (\n\t\t\t(parseInt(post.topic.mainPid, 10) === parseInt(post.pid, 10)) ||\n\t\t\t(ajaxify.data.selectedCids && ajaxify.data.selectedCids.length && ajaxify.data.selectedCids.indexOf(parseInt(post.topic.cid, 10)) === -1) ||\n\t\t\t(ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'new') ||\n\t\t\t(ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'watched' && !post.topic.isFollowing) ||\n\t\t\t(ajaxify.data.template.category && parseInt(ajaxify.data.cid, 10) !== parseInt(post.topic.cid, 10)) ||\n\t\t\t(!isCategoryVisible(post.topic.cid))\n\t\t)) {\n\t\t\treturn;\n\t\t}\n\n\t\tnewPostCount += 1;\n\t\tupdateAlertText();\n\t}\n\n\tfunction updateAlertText() {\n\t\tvar text = '';\n\n\t\tif (newTopicCount === 0) {\n\t\t\tif (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount === 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic]]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount > 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-are-new-topics, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-a-new-post, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-new-posts, ' + newTopicCount + ', ' + newPostCount + ']]';\n\t\t\t}\n\t\t}\n\n\t\ttext += ' [[recent:click-here-to-reload]]';\n\n\t\t$('#new-topics-alert').translateText(text).removeClass('hide').fadeIn('slow');\n\t\t$('#category-no-topics').addClass('hide');\n\t}\n\n\tTopicList.loadMoreTopics = function (direction) {\n\t\tif (!topicListEl.length || !topicListEl.children().length) {\n\t\t\treturn;\n\t\t}\n\t\tvar topics = topicListEl.find('[component=\"category/topic\"]');\n\t\tvar afterEl = direction > 0 ? topics.last() : topics.first();\n\t\tvar after = (parseInt(afterEl.attr('data-index'), 10) || 0) + (direction > 0 ? 1 : 0);\n\n\t\tif (!utils.isNumber(after) || (after === 0 && topicListEl.find('[component=\"category/topic\"][data-index=\"0\"]').length)) {\n\t\t\treturn;\n\t\t}\n\n\t\tloadTopicsCallback(after, direction, function (data, done) {\n\t\t\tTopicList.onTopicsLoaded(templateName, data.topics, ajaxify.data.showSelect, direction, done);\n\t\t});\n\t};\n\n\tfunction loadTopicsAfter(after, direction, callback) {\n\t\tcallback = callback || function () {};\n\t\tvar query = utils.params();\n\t\tinfinitescroll.loadMore('topics.loadMoreSortedTopics', {\n\t\t\tafter: after,\n\t\t\tdirection: direction,\n\t\t\tsort: tplToSort[templateName],\n\t\t\tcount: config.topicsPerPage,\n\t\t\tcid: query.cid,\n\t\t\tquery: query,\n\t\t\tterm: ajaxify.data.selectedTerm && ajaxify.data.selectedTerm.term,\n\t\t\tfilter: ajaxify.data.selectedFilter.filter,\n\t\t\tset: topicListEl.attr('data-set') ? topicListEl.attr('data-set') : 'topics:recent',\n\t\t}, callback);\n\t}\n\n\tfunction filterTopicsOnDom(topics) {\n\t\treturn topics.filter(function (topic) {\n\t\t\treturn !topicListEl.find('[component=\"category/topic\"][data-tid=\"' + topic.tid + '\"]').length;\n\t\t});\n\t}\n\n\tTopicList.onTopicsLoaded = function (templateName, topics, showSelect, direction, callback) {\n\t\tif (!topics || !topics.length) {\n\t\t\t$('#load-more-btn').hide();\n\t\t\treturn callback();\n\t\t}\n\t\ttopics = filterTopicsOnDom(topics);\n\n\t\tif (!topics.length) {\n\t\t\t$('#load-more-btn').hide();\n\t\t\treturn callback();\n\t\t}\n\n\t\tvar after;\n\t\tvar before;\n\t\tvar topicEls = topicListEl.find('[component=\"category/topic\"]');\n\n\t\tif (direction > 0 && topics.length) {\n\t\t\tafter = topicEls.last();\n\t\t} else if (direction < 0 && topics.length) {\n\t\t\tbefore = topicEls.first();\n\t\t}\n\n\t\tvar tplData = {\n\t\t\ttopics: topics,\n\t\t\tshowSelect: showSelect,\n\t\t\ttemplate: {\n\t\t\t\tname: templateName,\n\t\t\t},\n\t\t};\n\t\ttplData.template[templateName] = true;\n\n\t\tapp.parseAndTranslate(templateName, 'topics', tplData, function (html) {\n\t\t\ttopicListEl.removeClass('hidden');\n\t\t\t$('#category-no-topics').remove();\n\n\t\t\tif (after && after.length) {\n\t\t\t\thtml.insertAfter(after);\n\t\t\t} else if (before && before.length) {\n\t\t\t\tvar height = $(document).height();\n\t\t\t\tvar scrollTop = $(window).scrollTop();\n\n\t\t\t\thtml.insertBefore(before);\n\n\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\n\t\t\t} else {\n\t\t\t\ttopicListEl.append(html);\n\t\t\t}\n\n\t\t\tif (!topicSelect.getSelectedTids().length) {\n\t\t\t\tinfinitescroll.removeExtra(topicListEl.find('[component=\"category/topic\"]'), direction, config.topicsPerPage * 3);\n\t\t\t}\n\n\t\t\thtml.find('.timeago').timeago();\n\t\t\tapp.createUserTooltips(html);\n\t\t\tutils.makeNumbersHumanReadable(html.find('.human-readable-number'));\n\t\t\t$(window).trigger('action:topics.loaded', { topics: topics, template: templateName });\n\t\t\tcallback();\n\t\t});\n\t};\n\n\treturn TopicList;\n});\n"]}