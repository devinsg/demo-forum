"use strict";define("composer/drafts",function(){var e={};var t;e.init=function(r,o){var n=r.find(".draft-icon");function s(){a();t=setTimeout(function(){i(r,n,o)},1e3)}r.on("keyup","textarea, input.handle, input.title",s);r.on("click",'input[type="checkbox"]',s);n.on("animationend",function(){$(this).toggleClass("active",false)});$(window).on("unload",function(){var t=[];try{t=localStorage.getItem("drafts:open");t=JSON.parse(t)||[]}catch(e){console.warn("[composer/drafts] Could not read list of open/available drafts");t=[]}if(t.length){t.forEach(function(t){e.updateVisibility("open",t)})}});e.migrateGuest()};function a(){if(t){clearTimeout(t);t=0}}e.getDraft=function(e){console.warn("[composer/drafts] drafts.getDraft is deprecated! Use drafts.get() instead.");return localStorage.getItem(e)};e.get=function(e){var t=e.split(":")[1];var a=parseInt(t,10)?localStorage:sessionStorage;var i={text:a.getItem(e)};["cid","title","tags"].forEach(function(t){const r=a.getItem(e+":"+t);if(r){i[t]=r}});if(!parseInt(t,10)){i.handle=a.getItem(e+":handle")}$(window).trigger("action:composer.drafts.get",{save_id:e,draft:i,storage:a});return i};function i(t,a,i){if(r(app.user.uid?"localStorage":"sessionStorage")&&i&&i.save_id&&t.length){const r=t.find("input.title");const c=r&&r.val();var o=t.find("textarea").val();var n=app.user.uid?localStorage:sessionStorage;if(i.hasOwnProperty("cid")&&!i.save_id.endsWith(":cid:"+i.cid)){e.removeDraft(i.save_id);i.save_id=i.save_id.replace(/cid:\d+$/,"cid:"+i.cid)}if(o.length||c&&c.length){n.setItem(i.save_id,o);if(i.hasOwnProperty("cid")){const e=t.find("input.tags").val();n.setItem(i.save_id+":tags",e);n.setItem(i.save_id+":title",c)}if(!app.user.uid){var s=t.find("input.handle").val();n.setItem(i.save_id+":handle",s)}$(window).trigger("action:composer.drafts.save",{storage:n,postData:i,postContainer:t});a.toggleClass("active",true)}else{e.removeDraft(i.save_id)}}}e.removeDraft=function(t){if(!t){return}a();e.updateVisibility("available",t);e.updateVisibility("open",t);const i=Object.keys(localStorage).filter(e=>e.startsWith(t));i.forEach(e=>localStorage.removeItem(e))};e.updateVisibility=function(e,t,a){if(!r(app.user.uid?"localStorage":"sessionStorage")||!t){return}var i=[];try{i=localStorage.getItem("drafts:"+e);i=i?JSON.parse(i):[]}catch(e){console.warn("[composer/drafts] Could not read list of open drafts");i=[]}var o=i.indexOf(t);if(a&&o===-1){i.push(t)}else if(!a&&o!==-1){i.splice(o,1)}localStorage.setItem("drafts:"+e,JSON.stringify(i))};e.migrateGuest=function(){if(r("localStorage")&&app.user.uid){var t=/^composer:\d+:\w+:\d+(:\w+)?$/;var a=Object.keys(sessionStorage).filter(function(e){return t.test(e)});var i=new Set([]);var o=a.map(function(e){var t=e.split(":");t[1]=app.user.uid;i.add(t.slice(0,4).join(":"));return t.join(":")});a.forEach(function(e,t){localStorage.setItem(o[t],sessionStorage.getItem(e));sessionStorage.removeItem(e)});i.forEach(function(t){e.updateVisibility("available",t,1)});return i}};e.loadOpen=function(){var t;var a=[];try{t=localStorage.getItem("drafts:available");a=localStorage.getItem("drafts:open");t=JSON.parse(t)||[];a=JSON.parse(a)||[]}catch(e){console.warn("[composer/drafts] Could not read list of open/available drafts");t=[];a=[]}if(t.length&&app.user&&app.user.uid!==0){t.forEach(function(t){if(!t){return}var i=t.split(":");var r=i[1];var o=i[2];var n=i[3];var s=e.get(t);if(a.indexOf(t)!==-1){return}if(parseInt(app.user.uid,10)!==parseInt(r,10)){return}if(!s||s.text&&s.title&&!s.text.title&&!s.text.length){e.updateVisibility("available",t);e.updateVisibility("open",t);return}require(["composer"],function(e){if(o==="cid"){e.newTopic({cid:n,title:s.title,body:s.text,tags:[]})}else if(o==="tid"){socket.emit("topics.getTopic",n,function(t,a){if(t){return app.alertError(t.message)}e.newReply(n,undefined,a.title,s.text)})}else if(o==="pid"){e.editPost(n)}})})}};function r(e){var t;try{t=window[e];var a="__storage_test__";t.setItem(a,a);t.removeItem(a);return true}catch(e){return e instanceof DOMException&&(e.code===22||e.code===1014||e.name==="QuotaExceededError"||e.name==="NS_ERROR_DOM_QUOTA_REACHED")&&(t&&t.length!==0)}}return e});
//# sourceMappingURL=drafts.js.map