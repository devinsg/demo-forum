{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer/tags.js"],"names":["define","tags","minTags","maxTags","init","postContainer","postData","tagEl","find","length","ajaxify","data","hasOwnProperty","config","minimumTagsPerTopic","maximumTagsPerTopic","tagsinput","confirmKeys","trimValue","input","on","event","reachedMaxTags","getTags","attr","cleanTag","utils","cleanUpTag","item","maximumTagLength","different","cancel","minimumTagLength","app","alertError","cid","socket","emit","tag","err","allowed","message","$","window","trigger","autocomplete","toggleTagInput","loadJQueryUI","delay","position","my","at","collision","appendTo","open","this","css","source","request","response","query","term","select","triggerEnter","addTags","isEnoughTags","post_uuid","minTagCount","onChangeCategory","get","relative_path","tagDropdown","toggleClass","tagWhitelist","parseAndTranslate","html","slice","forEach","indexOf","removeAttr","privileges","tagsInput","e","jQuery","Event","which","keyCode","setTimeout","i"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer/tags.js","sourcesContent":["\r\n'use strict';\r\n\r\n/* globals jQuery, ajaxify, define, config, socket, app, utils, $, window */\r\n\r\ndefine('composer/tags', function () {\r\n\tvar tags = {};\r\n\r\n\tvar minTags;\r\n\tvar maxTags;\r\n\r\n\ttags.init = function (postContainer, postData) {\r\n\t\tvar tagEl = postContainer.find('.tags');\r\n\t\tif (!tagEl.length) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tminTags = ajaxify.data.hasOwnProperty('minTags') ? ajaxify.data.minTags : config.minimumTagsPerTopic;\r\n\t\tmaxTags = ajaxify.data.hasOwnProperty('maxTags') ? ajaxify.data.maxTags : config.maximumTagsPerTopic;\r\n\r\n\t\ttagEl.tagsinput({\r\n\t\t\tconfirmKeys: [13, 44],\r\n\t\t\ttrimValue: true,\r\n\t\t});\r\n\t\tvar input = postContainer.find('.bootstrap-tagsinput input');\r\n\r\n\t\ttagEl.on('beforeItemAdd', function (event) {\r\n\t\t\tvar reachedMaxTags = maxTags && maxTags <= tags.getTags(postContainer.attr('data-uuid')).length;\r\n\t\t\tvar cleanTag = utils.cleanUpTag(event.item, config.maximumTagLength);\r\n\t\t\tvar different = cleanTag !== event.item;\r\n\t\t\tevent.cancel = different ||\r\n\t\t\t\tevent.item.length < config.minimumTagLength ||\r\n\t\t\t\tevent.item.length > config.maximumTagLength ||\r\n\t\t\t\treachedMaxTags;\r\n\r\n\t\t\tif (event.item.length < config.minimumTagLength) {\r\n\t\t\t\treturn app.alertError('[[error:tag-too-short, ' + config.minimumTagLength + ']]');\r\n\t\t\t} else if (event.item.length > config.maximumTagLength) {\r\n\t\t\t\treturn app.alertError('[[error:tag-too-long, ' + config.maximumTagLength + ']]');\r\n\t\t\t} else if (reachedMaxTags) {\r\n\t\t\t\treturn app.alertError('[[error:too-many-tags, ' + maxTags + ']]');\r\n\t\t\t}\r\n\t\t\tif (different) {\r\n\t\t\t\ttagEl.tagsinput('add', cleanTag);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\ttagEl.on('itemAdded', function (event) {\r\n\t\t\tvar cid = postData.hasOwnProperty('cid') ? postData.cid : ajaxify.data.cid;\r\n\t\t\tsocket.emit('topics.isTagAllowed', { tag: event.item, cid: cid || 0 }, function (err, allowed) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t\tif (!allowed) {\r\n\t\t\t\t\treturn tagEl.tagsinput('remove', event.item);\r\n\t\t\t\t}\r\n\t\t\t\t$(window).trigger('action:tag.added', { cid: cid, tagEl: tagEl, tag: event.item });\r\n\t\t\t\tif (input.length) {\r\n\t\t\t\t\tinput.autocomplete('close');\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\ttoggleTagInput(postContainer, postData, ajaxify.data);\r\n\r\n\t\tapp.loadJQueryUI(function () {\r\n\t\t\tinput.autocomplete({\r\n\t\t\t\tdelay: 100,\r\n\t\t\t\tposition: { my: 'left bottom', at: 'left top', collision: 'flip' },\r\n\t\t\t\tappendTo: postContainer.find('.bootstrap-tagsinput'),\r\n\t\t\t\topen: function () {\r\n\t\t\t\t\t$(this).autocomplete('widget').css('z-index', 20000);\r\n\t\t\t\t},\r\n\t\t\t\tsource: function (request, response) {\r\n\t\t\t\t\tsocket.emit('topics.autocompleteTags', {\r\n\t\t\t\t\t\tquery: request.term,\r\n\t\t\t\t\t\tcid: postData.cid,\r\n\t\t\t\t\t}, function (err, tags) {\r\n\t\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (tags) {\r\n\t\t\t\t\t\t\tresponse(tags);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t$('.ui-autocomplete a').attr('data-ajaxify', 'false');\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t\tselect: function (/* event, ui */) {\r\n\t\t\t\t\t// when autocomplete is selected from the dropdown simulate a enter key down to turn it into a tag\r\n\t\t\t\t\ttriggerEnter(input);\r\n\t\t\t\t},\r\n\t\t\t});\r\n\r\n\t\t\taddTags(postData.tags, tagEl);\r\n\t\t});\r\n\r\n\t\tinput.attr('tabIndex', tagEl.attr('tabIndex'));\r\n\t\tinput.on('blur', function () {\r\n\t\t\ttriggerEnter(input);\r\n\t\t});\r\n\r\n\t\t$('[component=\"composer/tag/dropdown\"]').on('click', 'li', function () {\r\n\t\t\tvar tag = $(this).attr('data-tag');\r\n\t\t\tif (tag) {\r\n\t\t\t\taddTags([tag], tagEl);\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t});\r\n\t};\r\n\r\n\ttags.isEnoughTags = function (post_uuid) {\r\n\t\treturn tags.getTags(post_uuid).length >= minTags;\r\n\t};\r\n\r\n\ttags.minTagCount = function () {\r\n\t\treturn minTags;\r\n\t};\r\n\r\n\ttags.onChangeCategory = function (postContainer, postData, cid) {\r\n\t\t$.get(config.relative_path + '/api/category/' + cid, function (data) {\r\n\t\t\tvar tagDropdown = postContainer.find('[component=\"composer/tag/dropdown\"]');\r\n\t\t\tif (!tagDropdown.length) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\ttoggleTagInput(postContainer, postData, data);\r\n\t\t\ttagDropdown.toggleClass('hidden', !data.tagWhitelist || !data.tagWhitelist.length);\r\n\t\t\tif (data.tagWhitelist) {\r\n\t\t\t\tapp.parseAndTranslate('composer', 'tagWhitelist', { tagWhitelist: data.tagWhitelist }, function (html) {\r\n\t\t\t\t\ttagDropdown.find('.dropdown-menu').html(html);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tfunction toggleTagInput(postContainer, postData, data) {\r\n\t\tvar tagEl = postContainer.find('.tags');\r\n\t\tvar input = postContainer.find('.bootstrap-tagsinput input');\r\n\t\tif (!input.length) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (data.hasOwnProperty('minTags')) {\r\n\t\t\tminTags = data.minTags;\r\n\t\t}\r\n\t\tif (data.hasOwnProperty('maxTags')) {\r\n\t\t\tmaxTags = data.maxTags;\r\n\t\t}\r\n\r\n\t\tif (data.tagWhitelist && data.tagWhitelist.length) {\r\n\t\t\tinput.attr('readonly', '');\r\n\t\t\tinput.attr('placeholder', '');\r\n\r\n\t\t\ttagEl.tagsinput('items').slice().forEach(function (tag) {\r\n\t\t\t\tif (data.tagWhitelist.indexOf(tag) === -1) {\r\n\t\t\t\t\ttagEl.tagsinput('remove', tag);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tinput.removeAttr('readonly');\r\n\t\t\tinput.attr('placeholder', postContainer.find('input.tags').attr('placeholder'));\r\n\t\t}\r\n\r\n\t\tpostContainer.find('.tags-container').toggleClass('hidden', (\r\n\t\t\tdata.privileges && data.privileges.hasOwnProperty('topics:tag') && !data.privileges['topics:tag']) ||\r\n\t\t\t(maxTags === 0 && !postData.tags.length)\r\n\t\t);\r\n\r\n\t\tif (data.privileges && data.privileges.hasOwnProperty('topics:tag') && !data.privileges['topics:tag']) {\r\n\t\t\ttagEl.tagsinput('removeAll');\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:tag.toggleInput', {\r\n\t\t\tpostContainer: postContainer,\r\n\t\t\ttagWhitelist: data.tagWhitelist,\r\n\t\t\ttagsInput: input,\r\n\t\t});\r\n\t}\r\n\r\n\tfunction triggerEnter(input) {\r\n\t\t// http://stackoverflow.com/a/3276819/583363\r\n\t\tvar e = jQuery.Event('keypress');\r\n\t\te.which = 13;\r\n\t\te.keyCode = 13;\r\n\t\tsetTimeout(function () {\r\n\t\t\tinput.trigger(e);\r\n\t\t}, 100);\r\n\t}\r\n\r\n\tfunction addTags(tags, tagEl) {\r\n\t\tif (tags && tags.length) {\r\n\t\t\tfor (var i = 0; i < tags.length; ++i) {\r\n\t\t\t\ttagEl.tagsinput('add', tags[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttags.getTags = function (post_uuid) {\r\n\t\treturn $('.composer[data-uuid=\"' + post_uuid + '\"] .tags').tagsinput('items');\r\n\t};\r\n\r\n\treturn tags;\r\n});\r\n"]}