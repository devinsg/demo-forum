{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer.js"],"names":["define","taskbar","translator","controls","uploads","formatting","drafts","tags","categoryList","preview","resize","autocomplete","scrollStop","composer","active","undefined","posts","bsEnvironment","$","window","off","onWindowResize","on","document","onKeyUp","ev","data","localStorage","removeItem","cid","env","utils","findBootstrapEnvironment","modified","discard","discardConfirm","length","modal","translate","translated","bootbox","confirm","removeComposerHistory","ajaxify","template","compose","history","back","isMobile","toggle","reposition","location","pathname","startsWith","config","relative_path","mobileHistoryAppend","event","keycode","which","keyCode","minimize","alreadyOpen","post","type","id","hasOwnProperty","uuid","push","generateUUID","existingUUID","updateActive","load","actionText","action","translatedAction","title","replace","save_id","app","user","uid","join","tid","pid","composerAlert","post_uuid","message","find","removeAttr","alert","timeout","alert_id","findByTid","parseInt","addButton","iconClass","onClick","newTopic","pushData","body","isMain","trigger","addQuote","toPid","selectedPid","username","text","escapedTitle","link","newReply","postContainer","bodyEl","prevText","val","defaultLang","onTranslated","focusElements","render","editPost","socket","emit","err","threadData","alertError","activate","onShow","createNewComposer","options","enhance","postData","attr","titleEl","handleEl","tagsEl","submitBtn","init","addHandler","addComposerButtons","handleToggler","removeClass","privileges","initialize","allowTopicsThumbnail","toggleThumbEls","thumb","updateVisibility","e","preventDefault","stopPropagation","this","require","mousetrap","get","bind","btn","prop","matchScroll","draft","handle","split","forEach","tag","tagsinput","handleHelp","handleSearch","screenfull","enabled","addClass","isTopic","isEditing","isGuestPost","mobile","resizable","isTopicOrMain","minimumTagLength","maximumTagLength","showHandleInput","allowGuestHandles","isAdmin","tagWhitelist","toggleNavbar","createData","parseAndTranslate","composerTemplate","each","unescape","append","isActive","handleResize","submitBtns","mobileSubmitBtn","textareaEl","idx","toggleClass","composerData","apply","path","returnPath","slice","replaceState","url","pushState","helpBtn","html","enableTopicSearch","searchElements","inputEl","resultEl","hideOnNoMatches","setTimeout","focus","putCursorAtEnd","thumbEl","onComposeRoute","trim","rtrim","checkTitle","isCategorySelected","payload","titleLen","bodyLen","inProgress","minimumTitleLength","maximumTitleLength","minimumPostLength","maximumPostLength","isEnoughTags","minTagCount","content","getSelectedCid","getTags","submitHookData","composerEl","redirect","taskbarIconEl","showEmailConfirmWarning","removeDraft","queued","go","slug","name","topic","onHide","css","paddingBottom","remove","close"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer.js","sourcesContent":["'use strict';\r\n\r\n/* globals define, socket, app, config, ajaxify, utils, bootbox, screenfull */\r\n\r\ndefine('composer', [\r\n\t'taskbar',\r\n\t'translator',\r\n\t'composer/controls',\r\n\t'composer/uploads',\r\n\t'composer/formatting',\r\n\t'composer/drafts',\r\n\t'composer/tags',\r\n\t'composer/categoryList',\r\n\t'composer/preview',\r\n\t'composer/resize',\r\n\t'composer/autocomplete',\r\n\t'scrollStop'\r\n], function(taskbar, translator, controls, uploads, formatting, drafts, tags, categoryList, preview, resize, autocomplete, scrollStop) {\r\n\tvar composer = {\r\n\t\tactive: undefined,\r\n\t\tposts: {},\r\n\t\tbsEnvironment: undefined,\r\n\t\tformatting: undefined,\r\n\t};\r\n\r\n\t$(window).off('resize', onWindowResize).on('resize', onWindowResize);\r\n\t$(document).off('keyup', onKeyUp).on('keyup', onKeyUp);\r\n\tonWindowResize();\r\n\r\n\t$(window).on('action:composer.topics.post', function(ev, data) {\r\n\t\tlocalStorage.removeItem('category:' + data.data.cid + ':bookmark');\r\n\t\tlocalStorage.removeItem('category:' + data.data.cid + ':bookmark:clicked');\r\n\t});\r\n\r\n\t$(window).on('popstate', function() {\r\n\t\tvar env = utils.findBootstrapEnvironment();\r\n\t\tif (composer.active && (env === 'xs' || env ==='sm')) {\r\n\t\t\tif (!composer.posts[composer.active].modified) {\r\n\t\t\t\tcomposer.discard(composer.active);\r\n\t\t\t\tif (composer.discardConfirm && composer.discardConfirm.length) {\r\n\t\t\t\t\tcomposer.discardConfirm.modal('hide');\r\n\t\t\t\t\tdelete composer.discardConfirm;\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\ttranslator.translate('[[modules:composer.discard]]', function(translated) {\r\n\t\t\t\tcomposer.discardConfirm = bootbox.confirm(translated, function(confirm) {\r\n\t\t\t\t\tif (confirm) {\r\n\t\t\t\t\t\tcomposer.discard(composer.active);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tcomposer.posts[composer.active].modified = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tcomposer.posts[composer.active].modified = false;\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n\r\n\tfunction removeComposerHistory() {\r\n\t\tvar env = composer.bsEnvironment;\r\n\t\tif (ajaxify.data.template.compose === true || env === 'xs' || env ==='sm') {\r\n\t\t\thistory.back();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction onWindowResize() {\r\n\t\tvar env = utils.findBootstrapEnvironment();\r\n\t\tvar isMobile = env === 'xs' || env === 'sm';\r\n\r\n\t\tif (preview.toggle) {\r\n\t\t\tif (preview.env !== env && isMobile) {\r\n\t\t\t\tpreview.env = env;\r\n\t\t\t\tpreview.toggle(false);\r\n\t\t\t}\r\n\t\t\tpreview.env = env;\r\n\t\t}\r\n\r\n\t\tif (composer.active !== undefined) {\r\n\t\t\tresize.reposition($('.composer[data-uuid=\"' + composer.active + '\"]'));\r\n\r\n\t\t\tif (!isMobile && window.location.pathname.startsWith(config.relative_path + '/compose')) {\r\n\t\t\t\t/*\r\n\t\t\t\t *\tIf this conditional is met, we're no longer in mobile/tablet\r\n\t\t\t\t *\tresolution but we've somehow managed to have a mobile\r\n\t\t\t\t *\tcomposer load, so let's go back to the topic\r\n\t\t\t\t */\r\n\t\t\t\thistory.back();\r\n\t\t\t} else if (isMobile && !window.location.pathname.startsWith(config.relative_path + '/compose')) {\r\n\t\t\t\t/*\r\n\t\t\t\t *\tIn this case, we're in mobile/tablet resolution but the composer\r\n\t\t\t\t *\tthat loaded was a regular composer, so let's fix the address bar\r\n\t\t\t\t */\r\n\t\t\t\tmobileHistoryAppend();\r\n\t\t\t}\r\n\t\t}\r\n\t\tcomposer.bsEnvironment = env;\r\n\t}\r\n\r\n\tfunction onKeyUp(event) {\r\n\t\tif (composer.active) {\r\n\t\t\tvar keycode = (event.which ? event.which : event.keyCode);\r\n\t\t\tif (keycode === 27) {// escape\r\n\t\t\t\tcomposer.minimize(composer.active)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction alreadyOpen(post) {\r\n\t\t// If a composer for the same cid/tid/pid is already open, return the uuid, else return bool false\r\n\t\tvar\ttype, id;\r\n\r\n\t\tif (post.hasOwnProperty('cid')) {\r\n\t\t\ttype = 'cid';\r\n\t\t} else if (post.hasOwnProperty('tid')) {\r\n\t\t\ttype = 'tid';\r\n\t\t} else if (post.hasOwnProperty('pid')) {\r\n\t\t\ttype = 'pid';\r\n\t\t}\r\n\r\n\t\tid = post[type];\r\n\r\n\t\t// Find a match\r\n\t\tfor(var uuid in composer.posts) {\r\n\t\t\tif (composer.posts[uuid].hasOwnProperty(type) && id === composer.posts[uuid][type]) {\r\n\t\t\t\treturn uuid;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// No matches...\r\n\t\treturn false;\r\n\t}\r\n\r\n\tfunction push(post) {\r\n\t\tvar uuid = utils.generateUUID(),\r\n\t\t\texistingUUID = alreadyOpen(post);\r\n\r\n\t\tif (existingUUID) {\r\n\t\t\ttaskbar.updateActive(existingUUID);\r\n\t\t\treturn composer.load(existingUUID);\r\n\t\t}\r\n\r\n\t\tvar actionText = '[[topic:composer.new_topic]]';\r\n\t\tif (post.action === 'posts.reply') {\r\n\t\t\tactionText = '[[topic:composer.replying_to]]';\r\n\t\t} else if (post.action === 'posts.edit') {\r\n\t\t\tactionText = '[[topic:composer.editing]]';\r\n\t\t}\r\n\r\n\t\ttranslator.translate(actionText, function(translatedAction) {\r\n\t\t\ttaskbar.push('composer', uuid, {\r\n\t\t\t\ttitle: translatedAction.replace('%1', '\"' + post.title + '\"')\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\t// Construct a save_id\r\n\t\tif (post.hasOwnProperty('cid')) {\r\n\t\t\tpost.save_id = ['composer', app.user.uid, 'cid', post.cid].join(':');\r\n\t\t} else if (post.hasOwnProperty('tid')) {\r\n\t\t\tpost.save_id = ['composer', app.user.uid, 'tid', post.tid].join(':');\r\n\t\t} else if (post.hasOwnProperty('pid')) {\r\n\t\t\tpost.save_id = ['composer', app.user.uid, 'pid', post.pid].join(':');\r\n\t\t}\r\n\r\n\t\tcomposer.posts[uuid] = post;\r\n\t\tcomposer.load(uuid);\r\n\t}\r\n\r\n\tfunction composerAlert(post_uuid, message) {\r\n\t\t$('.composer[data-uuid=\"' + post_uuid + '\"]').find('.composer-submit').removeAttr('disabled');\r\n\t\tapp.alert({\r\n\t\t\ttype: 'danger',\r\n\t\t\ttimeout: 3000,\r\n\t\t\ttitle: '',\r\n\t\t\tmessage: message,\r\n\t\t\talert_id: 'post_error'\r\n\t\t});\r\n\t}\r\n\r\n\tcomposer.findByTid = function(tid) {\r\n\t\t// Iterates through the initialised composers and returns the uuid of the matching composer\r\n\t\tfor(var uuid in composer.posts) {\r\n\t\t\tif (composer.posts.hasOwnProperty(uuid) && composer.posts[uuid].hasOwnProperty('tid') && parseInt(composer.posts[uuid].tid, 10) === parseInt(tid, 10)) {\r\n\t\t\t\treturn uuid;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t};\r\n\r\n\tcomposer.addButton = function(iconClass, onClick, title) {\r\n\t\tformatting.addButton(iconClass, onClick, title);\r\n\t};\r\n\r\n\tcomposer.newTopic = function(data) {\r\n\t\tvar pushData = {\r\n\t\t\taction: 'topics.post',\r\n\t\t\tcid: data.cid,\r\n\t\t\ttitle: data.title || '',\r\n\t\t\tbody: data.body || '',\r\n\t\t\ttags: data.tags || [],\r\n\t\t\tmodified: ((data.title && data.title.length) || (data.body && data.body.length)) ? true : false,\r\n\t\t\tisMain: true\r\n\t\t};\r\n\r\n\t\t$(window).trigger('filter:composer.topic.push', {\r\n\t\t\tdata: data,\r\n\t\t\tpushData: pushData\r\n\t\t});\r\n\r\n\t\tpush(pushData);\r\n\t};\r\n\r\n\tcomposer.addQuote = function(tid, toPid, selectedPid, title, username, text, uuid) {\r\n\t\tuuid = uuid || composer.active;\r\n\r\n\t\tvar escapedTitle = (title || '').replace(/([\\\\`*_{}\\[\\]()#+\\-.!])/g, '\\\\$1').replace(/\\[/g, '&#91;').replace(/\\]/g, '&#93;').replace(/%/g, '&#37;').replace(/,/g, '&#44;');\r\n\r\n\t\tif (text) {\r\n\t\t\ttext = '> ' + text.replace(/\\n/g, '\\n> ') + '\\n\\n';\r\n\t\t}\r\n\t\tvar link = '[' + escapedTitle + '](' + config.relative_path + '/post/' + (selectedPid || toPid) + ')';\r\n\t\tif (uuid === undefined) {\r\n\t\t\tif (title && (selectedPid || toPid)) {\r\n\t\t\t\tcomposer.newReply(tid, toPid, title, '[[modules:composer.user_said_in, ' + username + ', ' + link + ']]\\n' + text);\r\n\t\t\t} else {\r\n\t\t\t\tcomposer.newReply(tid, toPid, title, '[[modules:composer.user_said, ' + username + ']]\\n' + text);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t} else if (uuid !== composer.active) {\r\n\t\t\t// If the composer is not currently active, activate it\r\n\t\t\tcomposer.load(uuid);\r\n\t\t}\r\n\r\n\t\tvar postContainer = $('.composer[data-uuid=\"' + uuid + '\"]');\r\n\t\tvar bodyEl = postContainer.find('textarea');\r\n\t\tvar prevText = bodyEl.val();\r\n\t\tif (title && (selectedPid || toPid)) {\r\n\t\t\ttranslator.translate('[[modules:composer.user_said_in, ' + username + ', ' + link + ']]\\n', config.defaultLang, onTranslated);\r\n\t\t} else {\r\n\t\t\ttranslator.translate('[[modules:composer.user_said, ' + username + ']]\\n', config.defaultLang, onTranslated);\r\n\t\t}\r\n\r\n\t\tfunction onTranslated(translated) {\r\n\t\t\tcomposer.posts[uuid].body = (prevText.length ? prevText + '\\n\\n' : '') + translated + text;\r\n\t\t\tbodyEl.val(composer.posts[uuid].body);\r\n\t\t\tfocusElements(postContainer);\r\n\t\t\tpreview.render(postContainer);\r\n\t\t}\r\n\t};\r\n\r\n\tcomposer.newReply = function(tid, toPid, title, text) {\r\n\t\ttranslator.translate(text, config.defaultLang, function(translated) {\r\n\t\t\tpush({\r\n\t\t\t\taction: 'posts.reply',\r\n\t\t\t\ttid: tid,\r\n\t\t\t\ttoPid: toPid,\r\n\t\t\t\ttitle: title,\r\n\t\t\t\tbody: translated,\r\n\t\t\t\tmodified: ((title && title.length) || (translated && translated.length)) ? true : false,\r\n\t\t\t\tisMain: false\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tcomposer.editPost = function(pid) {\r\n\t\tsocket.emit('plugins.composer.push', pid, function(err, threadData) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\t\t\tthreadData.action = 'posts.edit';\r\n\t\t\tthreadData.pid = pid;\r\n\t\t\tthreadData.modified = false;\r\n\t\t\tpush(threadData);\r\n\t\t});\r\n\t};\r\n\r\n\tcomposer.load = function(post_uuid) {\r\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\r\n\t\tif (postContainer.length) {\r\n\t\t\tactivate(post_uuid);\r\n\t\t\tresize.reposition(postContainer);\r\n\t\t\tfocusElements(postContainer);\r\n\t\t\tonShow();\r\n\t\t} else {\r\n\t\t\tif (composer.formatting) {\r\n\t\t\t\tcreateNewComposer(post_uuid);\r\n\t\t\t} else {\r\n\t\t\t\tsocket.emit('plugins.composer.getFormattingOptions', function(err, options) {\r\n\t\t\t\t\tcomposer.formatting = options;\r\n\t\t\t\t\tcreateNewComposer(post_uuid);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tcomposer.enhance = function(postContainer, post_uuid, postData) {\r\n\t\t/*\r\n\t\t\tThis method enhances a composer container with client-side sugar (preview, etc)\r\n\t\t\tEverything in here also applies to the /compose route\r\n\t\t*/\r\n\r\n\t\tif (!post_uuid && !postData) {\r\n\t\t\tpost_uuid = utils.generateUUID();\r\n\t\t\tcomposer.posts[post_uuid] = postData = ajaxify.data;\r\n\t\t\tpostContainer.attr('data-uuid', post_uuid);\r\n\t\t}\r\n\r\n\t\tvar titleEl = postContainer.find('input.title');\r\n\t\tvar handleEl = postContainer.find('input.handle');\r\n\t\tvar tagsEl = postContainer.find('input.tags');\r\n\t\tvar bodyEl = postContainer.find('textarea');\r\n\t\tvar submitBtn = postContainer.find('.composer-submit');\r\n\r\n\t\tcategoryList.init(postContainer, composer.posts[post_uuid]);\r\n\r\n\t\tformatting.addHandler(postContainer);\r\n\t\tformatting.addComposerButtons();\r\n\t\tpreview.handleToggler(postContainer);\r\n\r\n\t\tpostContainer.find('.img-upload-btn').removeClass('hide');\r\n\t\tpostContainer.find('#files.lt-ie9').removeClass('hide');\r\n\r\n\t\tif (app.user.privileges['upload:post:file']) {\r\n\t\t\tpostContainer.find('.file-upload-btn').removeClass('hide');\r\n\t\t\tpostContainer.find('#files.lt-ie9').removeClass('hide');\r\n\t\t}\r\n\r\n\t\tuploads.initialize(post_uuid);\r\n\r\n\t\tif (config.allowTopicsThumbnail && postData.isMain) {\r\n\t\t\tuploads.toggleThumbEls(postContainer, composer.posts[post_uuid].thumb || '');\r\n\t\t}\r\n\r\n\t\ttags.init(postContainer, composer.posts[post_uuid]);\r\n\r\n\t\tautocomplete.init(postContainer, post_uuid);\r\n\r\n\t\tpostContainer.on('change', 'input, textarea', function() {\r\n\t\t\tcomposer.posts[post_uuid].modified = true;\r\n\r\n\t\t\t// Post is modified, save to list of opened drafts\r\n\t\t\tdrafts.updateVisibility('available', composer.posts[post_uuid].save_id, true);\r\n\t\t\tdrafts.updateVisibility('open', composer.posts[post_uuid].save_id, true);\r\n\t\t});\r\n\r\n\t\tsubmitBtn.on('click', function(e) {\r\n\t\t\te.preventDefault();\r\n\t\t\te.stopPropagation();\t// Other click events bring composer back to active state which is undesired on submit\r\n\r\n\t\t\t$(this).attr('disabled', true);\r\n\t\t\tpost(post_uuid);\r\n\t\t});\r\n\r\n\t\trequire(['mousetrap'], function (mousetrap) {\r\n\t\t\tmousetrap(postContainer.get(0)).bind('mod+enter', function () {\r\n\t\t\t\tsubmitBtn.attr('disabled', true);\r\n\t\t\t\tpost(post_uuid);\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tpostContainer.find('.composer-discard').on('click', function(e) {\r\n\t\t\te.preventDefault();\r\n\r\n\t\t\tif (!composer.posts[post_uuid].modified) {\r\n\t\t\t\tcomposer.discard(post_uuid);\r\n\t\t\t\treturn removeComposerHistory();\r\n\t\t\t}\r\n\r\n\t\t\tvar btn = $(this).prop('disabled', true);\r\n\t\t\ttranslator.translate('[[modules:composer.discard]]', function(translated) {\r\n\t\t\t\tbootbox.confirm(translated, function(confirm) {\r\n\t\t\t\t\tif (confirm) {\r\n\t\t\t\t\t\tcomposer.discard(post_uuid);\r\n\t\t\t\t\t\tremoveComposerHistory();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbtn.prop('disabled', false);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tpostContainer.find('.composer-minimize, .minimize .trigger').on('click', function (e) {\r\n\t\t\te.preventDefault();\r\n\t\t\te.stopPropagation();\r\n\t\t\tcomposer.minimize(post_uuid);\r\n\t\t});\r\n\r\n\t\tbodyEl.on('input propertychange', function() {\r\n\t\t\tpreview.render(postContainer);\r\n\t\t});\r\n\r\n\t\tbodyEl.on('scroll', function() {\r\n\t\t\tpreview.matchScroll(postContainer);\r\n\t\t});\r\n\r\n\t\tpreview.render(postContainer, function() {\r\n\t\t\tpreview.matchScroll(postContainer);\r\n\t\t});\r\n\r\n\t\tdrafts.init(postContainer, postData);\r\n\t\tvar draft = drafts.get(postData.save_id);\r\n\t\tif (draft && draft.title) {\r\n\t\t\ttitleEl.val(draft.title);\r\n\t\t}\r\n\t\tif (draft && draft.handle) {\r\n\t\t\thandleEl.val(draft.handle);\r\n\t\t}\r\n\t\tif (draft && draft.tags) {\r\n\t\t\tconst tags = draft.tags.split(',');\r\n\t\t\ttags.forEach(function (tag) {\r\n\t\t\t\ttagsEl.tagsinput('add', tag);\r\n\t\t\t});\r\n\t\t}\r\n\t\tbodyEl.val(draft.text ? draft.text : postData.body);\r\n\r\n\t\thandleHelp(postContainer);\r\n\t\thandleSearch(postContainer);\r\n\t\tfocusElements(postContainer);\r\n\r\n\t\t// Hide \"zen mode\" if fullscreen API is not enabled/available (ahem, iOS...)\r\n\t\tif (typeof screenfull !== 'undefined' && !screenfull.enabled) {\r\n\t\t\t$('[data-format=\"zen\"]').addClass('hidden');\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:composer.enhanced', {\r\n\t\t\tpostContainer: postContainer,\r\n\t\t\tpostData: postData,\r\n\t\t\tdraft: draft,\r\n\t\t});\r\n\t};\r\n\r\n\tfunction createNewComposer(post_uuid) {\r\n\t\tvar postData = composer.posts[post_uuid];\r\n\r\n\t\tvar allowTopicsThumbnail = config.allowTopicsThumbnail && postData.isMain,\r\n\t\t\tisTopic = postData ? postData.hasOwnProperty('cid') : false,\r\n\t\t\tisMain = postData ? !!postData.isMain : false,\r\n\t\t\tisEditing = postData ? !!postData.pid : false,\r\n\t\t\tisGuestPost = postData ? parseInt(postData.uid, 10) === 0 : false;\r\n\r\n\t\t// see\r\n\t\t// https://github.com/NodeBB/NodeBB/issues/2994 and\r\n\t\t// https://github.com/NodeBB/NodeBB/issues/1951\r\n\t\t// remove when 1951 is resolved\r\n\r\n\t\tvar title = postData.title.replace(/%/g, '&#37;').replace(/,/g, '&#44;');\r\n\r\n\t\tvar data = {\r\n\t\t\ttitle: title,\r\n\t\t\tmobile: composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm',\r\n\t\t\tresizable: true,\r\n\t\t\tthumb: postData.thumb,\r\n\t\t\tallowTopicsThumbnail: allowTopicsThumbnail,\r\n\t\t\tisTopicOrMain: isTopic || isMain,\r\n\t\t\tminimumTagLength: config.minimumTagLength,\r\n\t\t\tmaximumTagLength: config.maximumTagLength,\r\n\t\t\tisTopic: isTopic,\r\n\t\t\tisEditing: isEditing,\r\n\t\t\tshowHandleInput:  config.allowGuestHandles && (app.user.uid === 0 || (isEditing && isGuestPost && app.user.isAdmin)),\r\n\t\t\thandle: postData ? postData.handle || '' : undefined,\r\n\t\t\tformatting: composer.formatting,\r\n\t\t\ttagWhitelist: ajaxify.data.tagWhitelist,\r\n\t\t\tprivileges: app.user.privileges,\r\n\t\t};\r\n\r\n\t\tif (data.mobile) {\r\n\t\t\tmobileHistoryAppend();\r\n\r\n\t\t\tapp.toggleNavbar(false);\r\n\t\t}\r\n\r\n\t\tpostData.mobile = composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm';\r\n\r\n\t\t$(window).trigger('filter:composer.create', {\r\n\t\t\tpostData: postData,\r\n\t\t\tcreateData: data\r\n\t\t});\r\n\r\n\t\tapp.parseAndTranslate('composer', data, function(composerTemplate) {\r\n\t\t\tif ($('.composer.composer[data-uuid=\"' + post_uuid + '\"]').length) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tcomposerTemplate = $(composerTemplate);\r\n\r\n\t\t\tcomposerTemplate.find('.title').each(function () {\r\n\t\t\t\t$(this).text(translator.unescape($(this).text()));\r\n\t\t\t});\r\n\r\n\t\t\tcomposerTemplate.attr('data-uuid', post_uuid);\r\n\r\n\t\t\t$(document.body).append(composerTemplate);\r\n\r\n\t\t\tvar postContainer = $(composerTemplate[0]);\r\n\r\n\t\t\tresize.reposition(postContainer);\r\n\t\t\tcomposer.enhance(postContainer, post_uuid, postData);\r\n\t\t\t/*\r\n\t\t\t\tEverything after this line is applied to the resizable composer only\r\n\t\t\t\tWant something done to both resizable composer and the one in /compose?\r\n\t\t\t\tPut it in composer.enhance().\r\n\r\n\t\t\t\tEventually, stuff after this line should be moved into composer.enhance().\r\n\t\t\t*/\r\n\r\n\t\t\tactivate(post_uuid);\r\n\r\n\t\t\tpostContainer.on('click', function() {\r\n\t\t\t\tif (!taskbar.isActive(post_uuid)) {\r\n\t\t\t\t\ttaskbar.updateActive(post_uuid);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tresize.handleResize(postContainer);\r\n\r\n\t\t\tif (composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm') {\r\n\t\t\t\tvar submitBtns = postContainer.find('.composer-submit'),\r\n\t\t\t\t\tmobileSubmitBtn = postContainer.find('.mobile-navbar .composer-submit'),\r\n\t\t\t\t\ttextareaEl = postContainer.find('.write'),\r\n\t\t\t\t\tidx = textareaEl.attr('tabindex');\r\n\r\n\t\t\t\tsubmitBtns.removeAttr('tabindex');\r\n\t\t\t\tmobileSubmitBtn.attr('tabindex', parseInt(idx, 10)+1);\r\n\r\n\t\t\t\t$('.category-name-container').on('click', function() {\r\n\t\t\t\t\t$('.category-selector').toggleClass('open');\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\t$(window).trigger('action:composer.loaded', {\r\n\t\t\t\tpost_uuid: post_uuid,\r\n\t\t\t\tcomposerData: composer.posts[post_uuid],\r\n\t\t\t\tformatting: composer.formatting,\r\n\t\t\t});\r\n\r\n\t\t\tscrollStop.apply(postContainer.find('.write'));\r\n\t\t\tfocusElements(postContainer);\r\n\t\t\tonShow();\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tfunction mobileHistoryAppend() {\r\n\t\tvar path = 'compose?p=' + window.location.pathname,\r\n\t\t\treturnPath = window.location.pathname.slice(1);\r\n\r\n\t\t// Remove relative path from returnPath\r\n\t\tif (returnPath.startsWith(config.relative_path.slice(1))) {\r\n\t\t\treturnPath = returnPath.slice(config.relative_path.length);\r\n\t\t}\r\n\r\n\t\t// Add in return path to be caught by ajaxify when post is completed, or if back is pressed\r\n\t\twindow.history.replaceState({\r\n\t\t\turl: null,\r\n\t\t\treturnPath: returnPath\r\n\t\t}, returnPath, config.relative_path + '/' + returnPath);\r\n\r\n\t\t// Update address bar in case f5 is pressed\r\n\t\twindow.history.pushState({\r\n\t\t\turl: path\r\n\t\t}, path, config.relative_path + '/' + path);\r\n\t}\r\n\r\n\tfunction handleHelp(postContainer) {\r\n\t\tvar helpBtn = postContainer.find('.help');\r\n\t\tsocket.emit('plugins.composer.renderHelp', function(err, html) {\r\n\t\t\tif (!err && html && html.length > 0) {\r\n\t\t\t\thelpBtn.removeClass('hidden');\r\n\t\t\t\thelpBtn.on('click', function() {\r\n\t\t\t\t\tbootbox.alert(html);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction handleSearch(postContainer) {\r\n\t\tvar uuid = postContainer.attr('data-uuid');\r\n\t\tvar isEditing = composer.posts[uuid] && composer.posts[uuid].action === 'posts.edit';\r\n\t\tvar env = utils.findBootstrapEnvironment();\r\n\t\tvar isMobile = env === 'xs' || env === 'sm';\r\n\t\tif (isEditing || isMobile) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tapp.enableTopicSearch({\r\n\t\t\tsearchElements: {\r\n\t\t\t\tinputEl: postContainer.find('input.title'),\r\n\t\t\t\tresultEl: postContainer.find('.quick-search-container'),\r\n\t\t\t},\r\n\t\t\thideOnNoMatches: true,\r\n\t\t});\r\n\t}\r\n\r\n\tfunction activate(post_uuid) {\r\n\t\tif(composer.active && composer.active !== post_uuid) {\r\n\t\t\tcomposer.minimize(composer.active);\r\n\t\t}\r\n\r\n\t\tcomposer.active = post_uuid;\r\n\t\t$(window).trigger('action:composer.activate', {\r\n\t\t\tpost_uuid: post_uuid,\r\n\t\t});\r\n\t}\r\n\r\n\tfunction focusElements(postContainer) {\r\n\t\tsetTimeout(function() {\r\n\t\t\tvar title = postContainer.find('input.title');\r\n\r\n\t\t\tif (title.length) {\r\n\t\t\t\ttitle.focus();\r\n\t\t\t} else {\r\n\t\t\t\tpostContainer.find('textarea').focus().putCursorAtEnd();\r\n\t\t\t}\r\n\t\t}, 20);\r\n\t}\r\n\r\n\tfunction post(post_uuid) {\r\n\t\tvar postData = composer.posts[post_uuid];\r\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\r\n\t\tvar handleEl = postContainer.find('.handle');\r\n\t\tvar titleEl = postContainer.find('.title');\r\n\t\tvar bodyEl = postContainer.find('textarea');\r\n\t\tvar thumbEl = postContainer.find('input#topic-thumb-url');\r\n\t\tvar onComposeRoute = postData.hasOwnProperty('template') && postData.template.compose === true;\r\n\r\n\t\ttitleEl.val(titleEl.val().trim());\r\n\t\tbodyEl.val(utils.rtrim(bodyEl.val()));\r\n\t\tif (thumbEl.length) {\r\n\t\t\tthumbEl.val(thumbEl.val().trim());\r\n\t\t}\r\n\r\n\t\tvar action = postData.action;\r\n\r\n\t\tvar checkTitle = (postData.hasOwnProperty('cid') || parseInt(postData.pid, 10)) && postContainer.find('input.title').length;\r\n\t\tvar isCategorySelected = !checkTitle || (checkTitle && parseInt(postData.cid, 10));\r\n\r\n\t\t// Specifically for checking title/body length via plugins\r\n\t\tvar payload = {\r\n\t\t\tpost_uuid: post_uuid,\r\n\t\t\tpostData: postData,\r\n\t\t\tpostContainer: postContainer,\r\n\t\t\ttitleEl: titleEl,\r\n\t\t\ttitleLen: titleEl.val().length,\r\n\t\t\tbodyEl: bodyEl,\r\n\t\t\tbodyLen: bodyEl.val().length,\r\n\t\t};\r\n\t\t$(window).trigger('action:composer.check', payload);\r\n\r\n\t\tif (uploads.inProgress[post_uuid] && uploads.inProgress[post_uuid].length) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:still-uploading]]');\r\n\t\t} else if (checkTitle && payload.titleLen < parseInt(config.minimumTitleLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:title-too-short, ' + config.minimumTitleLength + ']]');\r\n\t\t} else if (checkTitle && payload.titleLen > parseInt(config.maximumTitleLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:title-too-long, ' + config.maximumTitleLength + ']]');\r\n\t\t} else if (action === 'topics.post' && !isCategorySelected) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:category-not-selected]]');\r\n\t\t} else if (payload.bodyLen < parseInt(config.minimumPostLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:content-too-short, ' + config.minimumPostLength + ']]');\r\n\t\t} else if (payload.bodyLen > parseInt(config.maximumPostLength, 10)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:content-too-long, ' + config.maximumPostLength + ']]');\r\n\t\t} else if (checkTitle && !tags.isEnoughTags(post_uuid)) {\r\n\t\t\treturn composerAlert(post_uuid, '[[error:not-enough-tags, ' + tags.minTagCount() + ']]');\r\n\t\t}\r\n\r\n\t\tvar composerData = {};\r\n\r\n\t\tif (action === 'topics.post') {\r\n\t\t\tcomposerData = {\r\n\t\t\t\thandle: handleEl ? handleEl.val() : undefined,\r\n\t\t\t\ttitle: titleEl.val(),\r\n\t\t\t\tcontent: bodyEl.val(),\r\n\t\t\t\tthumb: thumbEl.val() || '',\r\n\t\t\t\tcid: categoryList.getSelectedCid(),\r\n\t\t\t\ttags: tags.getTags(post_uuid)\r\n\t\t\t};\r\n\t\t} else if (action === 'posts.reply') {\r\n\t\t\tcomposerData = {\r\n\t\t\t\ttid: postData.tid,\r\n\t\t\t\thandle: handleEl ? handleEl.val() : undefined,\r\n\t\t\t\tcontent: bodyEl.val(),\r\n\t\t\t\ttoPid: postData.toPid\r\n\t\t\t};\r\n\t\t} else if (action === 'posts.edit') {\r\n\t\t\tcomposerData = {\r\n\t\t\t\tpid: postData.pid,\r\n\t\t\t\thandle: handleEl ? handleEl.val() : undefined,\r\n\t\t\t\tcontent: bodyEl.val(),\r\n\t\t\t\ttitle: titleEl.val(),\r\n\t\t\t\tthumb: thumbEl.val() || '',\r\n\t\t\t\ttags: tags.getTags(post_uuid)\r\n\t\t\t};\r\n\t\t}\r\n\t\tvar submitHookData = {\r\n\t\t\tcomposerEl: postContainer,\r\n\t\t\taction: action,\r\n\t\t\tcomposerData: composerData,\r\n\t\t\tpostData: postData,\r\n\t\t\tredirect: true,\r\n\t\t}\r\n\t\t$(window).trigger('action:composer.submit', submitHookData);\r\n\r\n\t\t// Minimize composer (and set textarea as readonly) while submitting\r\n\t\tvar taskbarIconEl = $('#taskbar .composer[data-uuid=\"' + post_uuid + '\"] i');\r\n\t\tvar textareaEl = postContainer.find('.write');\r\n\t\ttaskbarIconEl.removeClass('fa-plus').addClass('fa-circle-o-notch fa-spin');\r\n\t\tcomposer.minimize(post_uuid);\r\n\t\ttextareaEl.prop('readonly', true);\r\n\r\n\t\tsocket.emit(action, composerData, function (err, data) {\r\n\t\t\tpostContainer.find('.composer-submit').removeAttr('disabled');\r\n\t\t\tif (err) {\r\n\t\t\t\t// Restore composer on error\r\n\t\t\t\tcomposer.load(post_uuid);\r\n\t\t\t\ttextareaEl.prop('readonly', false);\r\n\t\t\t\tif (err.message === '[[error:email-not-confirmed]]') {\r\n\t\t\t\t\treturn app.showEmailConfirmWarning(err);\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tcomposer.discard(post_uuid);\r\n\t\t\tdrafts.removeDraft(postData.save_id);\r\n\r\n\t\t\tif (data.queued) {\r\n\t\t\t\tbootbox.alert(data.message);\r\n\t\t\t} else {\r\n\t\t\t\tif (action === 'topics.post') {\r\n\t\t\t\t\tif (submitHookData.redirect) {\r\n\t\t\t\t\t\tajaxify.go('topic/' + data.slug, undefined, (onComposeRoute || composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm') ? true : false);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (action === 'posts.reply') {\r\n\t\t\t\t\tif (onComposeRoute || composer.bsEnvironment === 'xs' || composer.bsEnvironment === 'sm') {\r\n\t\t\t\t\t\twindow.history.back();\r\n\t\t\t\t\t} else if (submitHookData.redirect &&\r\n\t\t\t\t\t\t((ajaxify.data.template.name !== 'topic') ||\r\n\t\t\t\t\t\t(ajaxify.data.template.topic && parseInt(postData.tid, 10) !== parseInt(ajaxify.data.tid, 10)))\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\tajaxify.go('post/' + data.pid);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tremoveComposerHistory();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t$(window).trigger('action:composer.' + action, { composerData: composerData, data: data });\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onShow() {\r\n\t\t$('html').addClass('composing');\r\n\t}\r\n\r\n\tfunction onHide() {\r\n\t\t$('body').css({ paddingBottom: 0 });\r\n\t\t$('html').removeClass('composing');\r\n\t\tapp.toggleNavbar(true);\r\n\t}\r\n\r\n\tcomposer.discard = function(post_uuid) {\r\n\t\tif (composer.posts[post_uuid]) {\r\n\t\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\r\n\t\t\tpostContainer.remove();\r\n\t\t\tdrafts.removeDraft(composer.posts[post_uuid].save_id);\r\n\r\n\t\t\tdelete composer.posts[post_uuid];\r\n\t\t\tcomposer.active = undefined;\r\n\t\t\ttaskbar.discard('composer', post_uuid);\r\n\t\t\t$('[data-action=\"post\"]').removeAttr('disabled');\r\n\r\n\t\t\t$(window).trigger('action:composer.discard', {\r\n\t\t\t\tpost_uuid: post_uuid,\r\n\t\t\t});\r\n\t\t}\r\n\t\tonHide();\r\n\t};\r\n\r\n\t// Alias to .discard();\r\n\tcomposer.close = composer.discard;\r\n\r\n\tcomposer.minimize = function(post_uuid) {\r\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\r\n\t\tpostContainer.css('visibility', 'hidden');\r\n\t\tcomposer.active = undefined;\r\n\t\ttaskbar.minimize('composer', post_uuid);\r\n\t\t$(window).trigger('action:composer.minimize', {\r\n\t\t\tpost_uuid: post_uuid,\r\n\t\t});\r\n\r\n\t\tonHide();\r\n\t};\r\n\r\n\treturn composer;\r\n});\r\n"]}