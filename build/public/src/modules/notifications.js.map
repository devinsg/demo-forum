{"version":3,"sources":["public/src/modules/notifications.js"],"names":["define","translator","components","navigator","Benchpress","Tinycon","Notifications","unreadNotifs","loadNotifications","notifList","socket","emit","err","data","app","alertError","message","notifs","unread","concat","read","sort","a","b","parseInt","datetime","toggleTimeagoShorthand","i","length","timeago","$","Date","parse","notifications","html","translateHtml","off","on","ev","notifEl","this","scrollToPostIndexIfOnPage","stopPropagation","preventDefault","get","dropdown","hasClass","nid","attr","markNotification","markAllRead","liEl","parent","toggleClass","onNewNotification","notifData","ajaxify","currentPage","refresh","count","updateNotifCount","callback","pid","path","postEl","startsWith","config","relative_path","template","topic","scrollToIndex","notifIcon","Math","max","removeClass","addClass","payload","updateFavicon","window","trigger","setBubble"],"mappings":"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","file":"public/src/modules/notifications.js","sourcesContent":["'use strict';\n\n\ndefine('notifications', [\n\t'translator',\n\t'components',\n\t'navigator',\n\t'benchpress',\n\t'tinycon',\n], function (translator, components, navigator, Benchpress, Tinycon) {\n\tvar Notifications = {};\n\n\tvar unreadNotifs = {};\n\n\tNotifications.loadNotifications = function (notifList) {\n\t\tsocket.emit('notifications.get', null, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tvar notifs = data.unread.concat(data.read).sort(function (a, b) {\n\t\t\t\treturn parseInt(a.datetime, 10) > parseInt(b.datetime, 10) ? -1 : 1;\n\t\t\t});\n\n\t\t\ttranslator.toggleTimeagoShorthand(function () {\n\t\t\t\tfor (var i = 0; i < notifs.length; i += 1) {\n\t\t\t\t\tnotifs[i].timeago = $.timeago(new Date(parseInt(notifs[i].datetime, 10)));\n\t\t\t\t}\n\t\t\t\ttranslator.toggleTimeagoShorthand();\n\t\t\t\tBenchpress.parse('partials/notifications_list', { notifications: notifs }, function (html) {\n\t\t\t\t\tnotifList.translateHtml(html);\n\t\t\t\t\tnotifList.off('click').on('click', '[data-nid]', function (ev) {\n\t\t\t\t\t\tvar notifEl = $(this);\n\t\t\t\t\t\tif (scrollToPostIndexIfOnPage(notifEl)) {\n\t\t\t\t\t\t\tev.stopPropagation();\n\t\t\t\t\t\t\tev.preventDefault();\n\t\t\t\t\t\t\tcomponents.get('notifications/list').dropdown('toggle');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar unread = notifEl.hasClass('unread');\n\t\t\t\t\t\tif (!unread) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvar nid = notifEl.attr('data-nid');\n\t\t\t\t\t\tmarkNotification(nid, true);\n\t\t\t\t\t});\n\t\t\t\t\tcomponents.get('notifications').on('click', '.mark-all-read', Notifications.markAllRead);\n\n\t\t\t\t\tnotifList.on('click', '.mark-read', function () {\n\t\t\t\t\t\tvar liEl = $(this).parent();\n\t\t\t\t\t\tvar unread = liEl.hasClass('unread');\n\t\t\t\t\t\tvar nid = liEl.attr('data-nid');\n\t\t\t\t\t\tmarkNotification(nid, unread, function () {\n\t\t\t\t\t\t\tliEl.toggleClass('unread');\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tNotifications.onNewNotification = function (notifData) {\n\t\tif (ajaxify.currentPage === 'notifications') {\n\t\t\tajaxify.refresh();\n\t\t}\n\n\t\tsocket.emit('notifications.getCount', function (err, count) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tNotifications.updateNotifCount(count);\n\t\t});\n\n\t\tif (!unreadNotifs[notifData.nid]) {\n\t\t\tunreadNotifs[notifData.nid] = true;\n\t\t}\n\t};\n\n\tfunction markNotification(nid, read, callback) {\n\t\tsocket.emit('notifications.mark' + (read ? 'Read' : 'Unread'), nid, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (read && unreadNotifs[nid]) {\n\t\t\t\tdelete unreadNotifs[nid];\n\t\t\t}\n\t\t\tif (callback) {\n\t\t\t\tcallback();\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction scrollToPostIndexIfOnPage(notifEl) {\n\t\t// Scroll to index if already in topic (gh#5873)\n\t\tvar pid = notifEl.attr('data-pid');\n\t\tvar path = notifEl.attr('data-path');\n\t\tvar postEl = components.get('post', 'pid', pid);\n\t\tif (path.startsWith(config.relative_path + '/post/') && pid && postEl.length && ajaxify.data.template.topic) {\n\t\t\tnavigator.scrollToIndex(postEl.attr('data-index'), true);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tNotifications.updateNotifCount = function (count) {\n\t\tvar notifIcon = components.get('notifications/icon');\n\t\tcount = Math.max(0, count);\n\t\tif (count > 0) {\n\t\t\tnotifIcon.removeClass('fa-bell-o').addClass('fa-bell');\n\t\t} else {\n\t\t\tnotifIcon.removeClass('fa-bell').addClass('fa-bell-o');\n\t\t}\n\n\t\tnotifIcon.toggleClass('unread-count', count > 0);\n\t\tnotifIcon.attr('data-content', count > 99 ? '99+' : count);\n\n\t\tvar payload = {\n\t\t\tcount: count,\n\t\t\tupdateFavicon: true,\n\t\t};\n\t\t$(window).trigger('action:notification.updateCount', payload);\n\n\t\tif (payload.updateFavicon) {\n\t\t\tTinycon.setBubble(count > 99 ? '99+' : count);\n\t\t}\n\t};\n\n\tNotifications.markAllRead = function () {\n\t\tsocket.emit('notifications.markAllRead', function (err) {\n\t\t\tif (err) {\n\t\t\t\tapp.alertError(err.message);\n\t\t\t}\n\t\t\tunreadNotifs = {};\n\t\t});\n\t};\n\n\treturn Notifications;\n});\n"]}