{"version":3,"sources":["public/src/client/users.js"],"names":["define","translator","Benchpress","Users","searchTimeoutID","searchResultCount","$","window","on","clearTimeout","init","app","enterRoom","section","utils","params","removeClass","find","location","pathname","parent","addClass","handleSearch","handleInvite","socket","removeListener","onUserStatusChange","resultCount","setTimeout","doSearch","username","val","activeSection","getActiveSection","query","page","loadPage","sortBy","getSortBy","filters","is","push","length","qs","decodeURIComponent","param","get","config","relative_path","renderSearchResults","fail","xhrErr","responseJSON","error","alertError","data","parse","pagination","html","replaceWith","users","slice","translate","translated","timeago","startsWith","updateUser","updateUserStatus","uid","status","bootbox","prompt","email","emit","err","message","alertSuccess"],"mappings":"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","file":"public/src/client/users.js","sourcesContent":["'use strict';\n\n\ndefine('forum/users', ['translator', 'benchpress'], function (translator, Benchpress) {\n\tvar\tUsers = {};\n\n\tvar searchTimeoutID = 0;\n\tvar searchResultCount = 0;\n\n\t$(window).on('action:ajaxify.start', function () {\n\t\tif (searchTimeoutID) {\n\t\t\tclearTimeout(searchTimeoutID);\n\t\t\tsearchTimeoutID = 0;\n\t\t}\n\t});\n\n\tUsers.init = function () {\n\t\tapp.enterRoom('user_list');\n\n\t\tvar section = utils.params().section ? ('?section=' + utils.params().section) : '';\n\t\t$('.nav-pills li').removeClass('active').find('a[href=\"' + window.location.pathname + section + '\"]').parent()\n\t\t\t.addClass('active');\n\n\t\tUsers.handleSearch();\n\n\t\thandleInvite();\n\n\t\tsocket.removeListener('event:user_status_change', onUserStatusChange);\n\t\tsocket.on('event:user_status_change', onUserStatusChange);\n\t};\n\n\tUsers.handleSearch = function (params) {\n\t\tsearchResultCount = params && params.resultCount;\n\t\tsearchTimeoutID = 0;\n\n\t\t$('#search-user').on('keyup', function () {\n\t\t\tif (searchTimeoutID) {\n\t\t\t\tclearTimeout(searchTimeoutID);\n\t\t\t\tsearchTimeoutID = 0;\n\t\t\t}\n\n\t\t\tsearchTimeoutID = setTimeout(doSearch, 250);\n\t\t});\n\n\t\t$('.search select, .search input[type=\"checkbox\"]').on('change', function () {\n\t\t\tdoSearch();\n\t\t});\n\t};\n\n\tfunction doSearch() {\n\t\t$('[component=\"user/search/icon\"]').removeClass('fa-search').addClass('fa-spinner fa-spin');\n\t\tvar username = $('#search-user').val();\n\t\tvar activeSection = getActiveSection();\n\n\t\tvar query = {\n\t\t\tsection: activeSection,\n\t\t\tpage: 1,\n\t\t};\n\n\t\tif (!username) {\n\t\t\treturn loadPage(query);\n\t\t}\n\n\t\tquery.query = username;\n\t\tquery.sortBy = getSortBy();\n\t\tvar filters = [];\n\t\tif ($('.search .online-only').is(':checked') || (activeSection === 'online')) {\n\t\t\tfilters.push('online');\n\t\t}\n\t\tif (activeSection === 'banned') {\n\t\t\tfilters.push('banned');\n\t\t}\n\t\tif (activeSection === 'flagged') {\n\t\t\tfilters.push('flagged');\n\t\t}\n\t\tif (filters.length) {\n\t\t\tquery.filters = filters;\n\t\t}\n\n\t\tloadPage(query);\n\t}\n\n\tfunction getSortBy() {\n\t\tvar sortBy;\n\t\tvar activeSection = getActiveSection();\n\t\tif (activeSection === 'sort-posts') {\n\t\t\tsortBy = 'postcount';\n\t\t} else if (activeSection === 'sort-reputation') {\n\t\t\tsortBy = 'reputation';\n\t\t} else if (activeSection === 'users') {\n\t\t\tsortBy = 'joindate';\n\t\t}\n\t\treturn sortBy;\n\t}\n\n\n\tfunction loadPage(query) {\n\t\tvar qs = decodeURIComponent($.param(query));\n\t\t$.get(config.relative_path + '/api/users?' + qs, renderSearchResults).fail(function (xhrErr) {\n\t\t\tif (xhrErr && xhrErr.responseJSON && xhrErr.responseJSON.error) {\n\t\t\t\tapp.alertError(xhrErr.responseJSON.error);\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction renderSearchResults(data) {\n\t\tBenchpress.parse('partials/paginator', { pagination: data.pagination }, function (html) {\n\t\t\t$('.pagination-container').replaceWith(html);\n\t\t});\n\n\t\tif (searchResultCount) {\n\t\t\tdata.users = data.users.slice(0, searchResultCount);\n\t\t}\n\n\t\tBenchpress.parse('users', 'users', data, function (html) {\n\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\ttranslated = $(translated);\n\t\t\t\t$('#users-container').html(translated);\n\t\t\t\ttranslated.find('span.timeago').timeago();\n\t\t\t\t$('[component=\"user/search/icon\"]').addClass('fa-search').removeClass('fa-spinner fa-spin');\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction onUserStatusChange(data) {\n\t\tvar section = getActiveSection();\n\n\t\tif ((section.startsWith('online') || section.startsWith('users'))) {\n\t\t\tupdateUser(data);\n\t\t}\n\t}\n\n\tfunction updateUser(data) {\n\t\tapp.updateUserStatus($('#users-container [data-uid=\"' + data.uid + '\"] [component=\"user/status\"]'), data.status);\n\t}\n\n\tfunction getActiveSection() {\n\t\treturn utils.params().section || '';\n\t}\n\n\tfunction handleInvite() {\n\t\t$('[component=\"user/invite\"]').on('click', function () {\n\t\t\tbootbox.prompt('[[users:prompt-email]]', function (email) {\n\t\t\t\tif (!email) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsocket.emit('user.invite', email, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tapp.alertSuccess('[[users:invitation-email-sent, ' + email + ']]');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\treturn Users;\n});\n"]}