{"version":3,"sources":["public/src/client/groups/memberlist.js"],"names":["define","api","MemberList","searchInterval","groupName","templateName","init","_templateName","ajaxify","data","group","name","handleMemberAdd","handleMemberSearch","handleMemberInfiniteScroll","$","on","app","parseAndTranslate","html","foundUsers","modal","bootbox","dialog","title","message","buttons","ok","callback","users","find","each","index","el","push","attr","addUserToGroup","isSelected","this","removeAttr","toggleClass","socket","emit","query","val","paginate","err","result","alertError","forEach","user","uid","done","filter","length","prepend","uids","map","Promise","all","put","slug","then","clearInterval","setTimeout","results","$this","bottom","scrollHeight","innerHeight","scrollTop","loadMoreMembers","members","after","onMembersLoaded","nextStart","append","isOwner"],"mappings":"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","file":"public/src/client/groups/memberlist.js","sourcesContent":["'use strict';\n\ndefine('forum/groups/memberlist', ['api'], function (api) {\n\tvar MemberList = {};\n\tvar searchInterval;\n\tvar groupName;\n\tvar templateName;\n\n\tMemberList.init = function (_templateName) {\n\t\ttemplateName = _templateName || 'groups/details';\n\t\tgroupName = ajaxify.data.group.name;\n\n\t\thandleMemberAdd();\n\t\thandleMemberSearch();\n\t\thandleMemberInfiniteScroll();\n\t};\n\n\tfunction handleMemberAdd() {\n\t\t$('[component=\"groups/members/add\"]').on('click', function () {\n\t\t\tapp.parseAndTranslate('admin/partials/groups/add-members', {}, function (html) {\n\t\t\t\tvar foundUsers = [];\n\t\t\t\tvar modal = bootbox.dialog({\n\t\t\t\t\ttitle: '[[groups:details.add-member]]',\n\t\t\t\t\tmessage: html,\n\t\t\t\t\tbuttons: {\n\t\t\t\t\t\tok: {\n\t\t\t\t\t\t\tcallback: function () {\n\t\t\t\t\t\t\t\tvar users = [];\n\t\t\t\t\t\t\t\tmodal.find('[data-uid][data-selected]').each(function (index, el) {\n\t\t\t\t\t\t\t\t\tusers.push(foundUsers[$(el).attr('data-uid')]);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\taddUserToGroup(users, function () {\n\t\t\t\t\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tmodal.on('click', '[data-username]', function () {\n\t\t\t\t\tvar isSelected = $(this).attr('data-selected') === '1';\n\t\t\t\t\tif (isSelected) {\n\t\t\t\t\t\t$(this).removeAttr('data-selected');\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$(this).attr('data-selected', 1);\n\t\t\t\t\t}\n\t\t\t\t\t$(this).find('i').toggleClass('invisible');\n\t\t\t\t});\n\t\t\t\tmodal.find('input').on('keyup', function () {\n\t\t\t\t\tsocket.emit('user.search', {\n\t\t\t\t\t\tquery: $(this).val(),\n\t\t\t\t\t\tpaginate: false,\n\t\t\t\t\t}, function (err, result) {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult.users.forEach(function (user) {\n\t\t\t\t\t\t\tfoundUsers[user.uid] = user;\n\t\t\t\t\t\t});\n\t\t\t\t\t\tapp.parseAndTranslate('admin/partials/groups/add-members', 'users', { users: result.users }, function (html) {\n\t\t\t\t\t\t\tmodal.find('#search-result').html(html);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction addUserToGroup(users, callback) {\n\t\tfunction done() {\n\t\t\tusers = users.filter(function (user) {\n\t\t\t\treturn !$('[component=\"groups/members\"] [data-uid=\"' + user.uid + '\"]').length;\n\t\t\t});\n\t\t\tparseAndTranslate(users, function (html) {\n\t\t\t\t$('[component=\"groups/members\"] tbody').prepend(html);\n\t\t\t});\n\t\t\tcallback();\n\t\t}\n\t\tvar uids = users.map(function (user) { return user.uid; });\n\t\tif (groupName === 'administrators') {\n\t\t\tsocket.emit('admin.user.makeAdmins', uids, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tdone();\n\t\t\t});\n\t\t} else {\n\t\t\tPromise.all(uids.map(uid => api.put('/groups/' + ajaxify.data.group.slug + '/membership/' + uid))).then(done);\n\t\t}\n\t}\n\n\tfunction handleMemberSearch() {\n\t\t$('[component=\"groups/members/search\"]').on('keyup', function () {\n\t\t\tvar query = $(this).val();\n\t\t\tif (searchInterval) {\n\t\t\t\tclearInterval(searchInterval);\n\t\t\t\tsearchInterval = 0;\n\t\t\t}\n\n\t\t\tsearchInterval = setTimeout(function () {\n\t\t\t\tsocket.emit('groups.searchMembers', { groupName: groupName, query: query }, function (err, results) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tparseAndTranslate(results.users, function (html) {\n\t\t\t\t\t\t$('[component=\"groups/members\"] tbody').html(html);\n\t\t\t\t\t\t$('[component=\"groups/members\"]').attr('data-nextstart', 20);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}, 250);\n\t\t});\n\t}\n\n\tfunction handleMemberInfiniteScroll() {\n\t\t$('[component=\"groups/members\"] tbody').on('scroll', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar bottom = ($this[0].scrollHeight - $this.innerHeight()) * 0.9;\n\n\t\t\tif ($this.scrollTop() > bottom && !$('[component=\"groups/members/search\"]').val()) {\n\t\t\t\tloadMoreMembers();\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction loadMoreMembers() {\n\t\tvar members = $('[component=\"groups/members\"]');\n\t\tif (members.attr('loading')) {\n\t\t\treturn;\n\t\t}\n\n\t\tmembers.attr('loading', 1);\n\t\tsocket.emit('groups.loadMoreMembers', {\n\t\t\tgroupName: groupName,\n\t\t\tafter: members.attr('data-nextstart'),\n\t\t}, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (data && data.users.length) {\n\t\t\t\tonMembersLoaded(data.users, function () {\n\t\t\t\t\tmembers.removeAttr('loading');\n\t\t\t\t\tmembers.attr('data-nextstart', data.nextStart);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tmembers.removeAttr('loading');\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction onMembersLoaded(users, callback) {\n\t\tusers = users.filter(function (user) {\n\t\t\treturn !$('[component=\"groups/members\"] [data-uid=\"' + user.uid + '\"]').length;\n\t\t});\n\n\t\tparseAndTranslate(users, function (html) {\n\t\t\t$('[component=\"groups/members\"] tbody').append(html);\n\t\t\tcallback();\n\t\t});\n\t}\n\n\tfunction parseAndTranslate(users, callback) {\n\t\tapp.parseAndTranslate(templateName, 'group.members', {\n\t\t\tgroup: {\n\t\t\t\tmembers: users,\n\t\t\t\tisOwner: ajaxify.data.group.isOwner,\n\t\t\t},\n\t\t}, callback);\n\t}\n\n\treturn MemberList;\n});\n"]}