{"version":3,"sources":["public/src/client/flags/list.js"],"names":["define","components","Chart","Flags","init","enableFilterForm","enableCheckboxes","handleBulkActions","get","on","e","includes","target","nodeName","flagId","this","getAttribute","ajaxify","go","graphWrapper","$","graphFooter","siblings","one","handleGraphs","collapse","bind","filtersEl","filter","data","filters","hasOwnProperty","find","val","sort","document","getElementById","addEventListener","payload","serializeArray","length","param","flagsList","querySelector","checkboxes","querySelectorAll","bulkEl","lastClicked","state","checked","forEach","el","disabled","subselector","closest","stopImmediatePropagation","shiftKey","started","some","ref","Array","prototype","call","action","flagIds","getSelected","promises","push","Promise","resolve","reject","handler","err","arguments","socket","emit","name","value","app","user","uid","allSettled","then","results","fulfilled","res","status","errors","alertSuccess","alertError","reason","dailyCanvas","dailyLabels","utils","getDaysArray","map","text","idx","isMobile","defaults","global","tooltips","enabled","flags:daily","labels","datasets","label","backgroundColor","borderColor","pointBackgroundColor","pointHoverBackgroundColor","pointBorderColor","pointHoverBorderColor","analytics","width","parent","getContext","type","options","responsive","animation","legend","display","scales","yAxes","ticks","beginAtZero","precision"],"mappings":"AAAA,aAEAA,OAAO,oBAAqB,aAAc,SAAU,SAAUC,EAAYC,GACzE,IAAIC,KAEJA,EAAMC,KAAO,WACZD,EAAME,mBACNF,EAAMG,mBACNH,EAAMI,oBAENN,EAAWO,IAAI,cACbC,GAAG,QAAS,iBAAkB,SAAUC,GACxC,IAAK,SAAU,KAAKC,SAASD,EAAEE,OAAOC,UAAW,CAChD,OAGD,IAAIC,EAASC,KAAKC,aAAa,gBAC/BC,QAAQC,GAAG,SAAWJ,KAGxB,IAAIK,EAAeC,EAAE,wBACrB,IAAIC,EAAcF,EAAaG,SAAS,iBACxCF,EAAE,wBAAwBG,IAAI,oBAAqB,WAClDpB,EAAMqB,iBAEPH,EAAYZ,GAAG,QAASU,EAAaM,SAASC,KAAKP,EAAc,YAGlEhB,EAAME,iBAAmB,WACxB,IAAIsB,EAAY1B,EAAWO,IAAI,iBAG/B,IAAK,IAAIoB,KAAUX,QAAQY,KAAKC,QAAS,CACxC,GAAIb,QAAQY,KAAKC,QAAQC,eAAeH,GAAS,CAChDD,EAAUK,KAAK,UAAYJ,EAAS,MAAMK,IAAIhB,QAAQY,KAAKC,QAAQF,KAGrED,EAAUK,KAAK,iBAAiBC,IAAIhB,QAAQY,KAAKK,MAEjDC,SAASC,eAAe,iBAAiBC,iBAAiB,QAAS,WAClE,IAAIC,EAAUX,EAAUY,iBACxBtB,QAAQC,GAAG,UAAYoB,EAAQE,OAASpB,EAAEqB,MAAMH,GAAW,eAI7DnC,EAAMG,iBAAmB,WACxB,IAAIoC,EAAYP,SAASQ,cAAc,4BACvC,IAAIC,EAAaF,EAAUG,iBAAiB,yCAC5C,IAAIC,EAASX,SAASQ,cAAc,2CACpC,IAAII,EAEJZ,SAASQ,cAAc,8BAA8BN,iBAAiB,QAAS,WAC9E,IAAIW,EAAQjC,KAAKkC,QAEjBL,EAAWM,QAAQ,SAAUC,GAC5BA,EAAGF,QAAUD,IAEdF,EAAOM,UAAYJ,IAGpBN,EAAUL,iBAAiB,QAAS,SAAU3B,GAC7C,IAAI2C,EAAc3C,EAAEE,OAAO0C,QAAQ,0BACnC,GAAID,EAAa,CAEhB3C,EAAE6C,2BAEF,GAAIR,GAAerC,EAAE8C,UAAYT,IAAgBM,EAAa,CAE7D,IAAIL,EAAQK,EAAYJ,QACxB,IAAIQ,EAAU,MAEdb,EAAWM,QAAQ,SAAUC,GAC5B,IAAKE,EAAaN,GAAaW,KAAK,SAAUC,GAC7C,OAAOA,IAAQR,IACZ,CACHM,GAAWA,EAGZ,GAAIA,EAAS,CACZN,EAAGF,QAAUD,KAMhBF,EAAOM,UAAYQ,MAAMC,UAAUH,KAAKI,KAAKlB,EAAY,SAAUO,GAClE,OAAOA,EAAGF,UAGXF,EAAcM,EAIf,GAAI3C,EAAEE,OAAO+B,cAAc,0BAA2B,CACrDjC,EAAE6C,+BAKLpD,EAAMI,kBAAoB,WACzB4B,SAASQ,cAAc,oCAAoCN,iBAAiB,QAAS,SAAU3B,GAC9F,IAAI2C,EAAc3C,EAAEE,OAAO0C,QAAQ,iBACnC,GAAID,EAAa,CAChB,IAAIU,EAASV,EAAYrC,aAAa,eACtC,IAAIgD,EAAU7D,EAAM8D,cACpB,IAAIC,KAGJF,EAAQd,QAAQ,SAAUpC,GACzBoD,EAASC,KAAK,IAAIC,QAAQ,SAAUC,EAASC,GAC5C,IAAIC,EAAU,SAAUC,GACvB,GAAIA,EAAK,CACRF,EAAOE,GAGRH,EAAQI,UAAU,KAGnB,OAAQV,GACP,IAAK,cACJW,OAAOC,KAAK,gBACX7D,OAAQA,EACRe,OAEE+C,KAAM,WACNC,MAAOC,IAAIC,KAAKC,OAGhBT,GACH,MAED,IAAK,qBACJG,OAAOC,KAAK,gBACX7D,OAAQA,EACRe,OAEE+C,KAAM,QACNC,MAAO,cAGPN,GACH,YAKJH,QAAQa,WAAWf,GAAUgB,KAAK,SAAUC,GAC3C,IAAIC,EAAYD,EAAQvD,OAAO,SAAUyD,GACxC,OAAOA,EAAIC,SAAW,cACpB9C,OACH,IAAI+C,EAASJ,EAAQvD,OAAO,SAAUyD,GACrC,OAAOA,EAAIC,SAAW,aAEvB,GAAIF,EAAW,CACdN,IAAIU,aAAa,yBAA2BJ,EAAY,MAGzDG,EAAOrC,QAAQ,SAAUmC,GACxBP,IAAIW,WAAWJ,EAAIK,gBAOxBvF,EAAM8D,YAAc,WACnB,IAAIrB,EAAaT,SAASU,iBAAiB,kEAC3C,IAAIP,KACJM,EAAWM,QAAQ,SAAUC,GAC5B,GAAIA,EAAGF,QAAS,CACfX,EAAQ6B,KAAKhB,EAAGG,QAAQ,kBAAkBtC,aAAa,oBAIzD,OAAOsB,GAGRnC,EAAMqB,aAAe,WACpB,IAAImE,EAAcxD,SAASC,eAAe,eAC1C,IAAIwD,EAAcC,MAAMC,eAAeC,IAAI,SAAUC,EAAMC,GAC1D,OAAOA,EAAM,EAAI,GAAKD,IAGvB,GAAIH,MAAMK,WAAY,CACrBhG,EAAMiG,SAASC,OAAOC,SAASC,QAAU,MAE1C,IAAIzE,GACH0E,eACCC,OAAQZ,EACRa,WAEEC,MAAO,GACPC,gBAAiB,wBACjBC,YAAa,sBACbC,qBAAsB,sBACtBC,0BAA2B,OAC3BC,iBAAkB,OAClBC,sBAAuB,sBACvBnF,KAAMZ,QAAQY,KAAKoF,cAMvBtB,EAAYuB,MAAQ9F,EAAEuE,GAAawB,SAASD,QAC5C,IAAIhH,EAAMyF,EAAYyB,WAAW,OAChCC,KAAM,OACNxF,KAAMA,EAAK,eACXyF,SACCC,WAAY,KACZC,UAAW,MACXC,QACCC,QAAS,OAEVC,QACCC,QACCC,OACCC,YAAa,KACbC,UAAW,UAQjB,OAAO5H","file":"public/src/client/flags/list.js","sourcesContent":["'use strict';\n\ndefine('forum/flags/list', ['components', 'Chart'], function (components, Chart) {\n\tvar Flags = {};\n\n\tFlags.init = function () {\n\t\tFlags.enableFilterForm();\n\t\tFlags.enableCheckboxes();\n\t\tFlags.handleBulkActions();\n\n\t\tcomponents.get('flags/list')\n\t\t\t.on('click', '[data-flag-id]', function (e) {\n\t\t\t\tif (['BUTTON', 'A'].includes(e.target.nodeName)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar flagId = this.getAttribute('data-flag-id');\n\t\t\t\tajaxify.go('flags/' + flagId);\n\t\t\t});\n\n\t\tvar graphWrapper = $('#flags-daily-wrapper');\n\t\tvar graphFooter = graphWrapper.siblings('.panel-footer');\n\t\t$('#flags-daily-wrapper').one('shown.bs.collapse', function () {\n\t\t\tFlags.handleGraphs();\n\t\t});\n\t\tgraphFooter.on('click', graphWrapper.collapse.bind(graphWrapper, 'toggle'));\n\t};\n\n\tFlags.enableFilterForm = function () {\n\t\tvar filtersEl = components.get('flags/filters');\n\n\t\t// Parse ajaxify data to set form values to reflect current filters\n\t\tfor (var filter in ajaxify.data.filters) {\n\t\t\tif (ajaxify.data.filters.hasOwnProperty(filter)) {\n\t\t\t\tfiltersEl.find('[name=\"' + filter + '\"]').val(ajaxify.data.filters[filter]);\n\t\t\t}\n\t\t}\n\t\tfiltersEl.find('[name=\"sort\"]').val(ajaxify.data.sort);\n\n\t\tdocument.getElementById('apply-filters').addEventListener('click', function () {\n\t\t\tvar payload = filtersEl.serializeArray();\n\t\t\tajaxify.go('flags?' + (payload.length ? $.param(payload) : 'reset=1'));\n\t\t});\n\t};\n\n\tFlags.enableCheckboxes = function () {\n\t\tvar flagsList = document.querySelector('[component=\"flags/list\"]');\n\t\tvar checkboxes = flagsList.querySelectorAll('[data-flag-id] input[type=\"checkbox\"]');\n\t\tvar bulkEl = document.querySelector('[component=\"flags/bulk-actions\"] button');\n\t\tvar lastClicked;\n\n\t\tdocument.querySelector('[data-action=\"toggle-all\"]').addEventListener('click', function () {\n\t\t\tvar state = this.checked;\n\n\t\t\tcheckboxes.forEach(function (el) {\n\t\t\t\tel.checked = state;\n\t\t\t});\n\t\t\tbulkEl.disabled = !state;\n\t\t});\n\n\t\tflagsList.addEventListener('click', function (e) {\n\t\t\tvar subselector = e.target.closest('input[type=\"checkbox\"]');\n\t\t\tif (subselector) {\n\t\t\t\t// Stop checkbox clicks from going into the flag details\n\t\t\t\te.stopImmediatePropagation();\n\n\t\t\t\tif (lastClicked && e.shiftKey && lastClicked !== subselector) {\n\t\t\t\t\t// Select all the checkboxes in between\n\t\t\t\t\tvar state = subselector.checked;\n\t\t\t\t\tvar started = false;\n\n\t\t\t\t\tcheckboxes.forEach(function (el) {\n\t\t\t\t\t\tif ([subselector, lastClicked].some(function (ref) {\n\t\t\t\t\t\t\treturn ref === el;\n\t\t\t\t\t\t})) {\n\t\t\t\t\t\t\tstarted = !started;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (started) {\n\t\t\t\t\t\t\tel.checked = state;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// (De)activate bulk actions button based on checkboxes' state\n\t\t\t\tbulkEl.disabled = !Array.prototype.some.call(checkboxes, function (el) {\n\t\t\t\t\treturn el.checked;\n\t\t\t\t});\n\n\t\t\t\tlastClicked = subselector;\n\t\t\t}\n\n\t\t\t// If you miss the checkbox, don't descend into the flag details, either\n\t\t\tif (e.target.querySelector('input[type=\"checkbox\"]')) {\n\t\t\t\te.stopImmediatePropagation();\n\t\t\t}\n\t\t});\n\t};\n\n\tFlags.handleBulkActions = function () {\n\t\tdocument.querySelector('[component=\"flags/bulk-actions\"]').addEventListener('click', function (e) {\n\t\t\tvar subselector = e.target.closest('[data-action]');\n\t\t\tif (subselector) {\n\t\t\t\tvar action = subselector.getAttribute('data-action');\n\t\t\t\tvar flagIds = Flags.getSelected();\n\t\t\t\tvar promises = [];\n\n\t\t\t\t// TODO: this can be better done with flagIds.map to return promises\n\t\t\t\tflagIds.forEach(function (flagId) {\n\t\t\t\t\tpromises.push(new Promise(function (resolve, reject) {\n\t\t\t\t\t\tvar handler = function (err) {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\treject(err);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(arguments[1]);\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tswitch (action) {\n\t\t\t\t\t\t\tcase 'bulk-assign':\n\t\t\t\t\t\t\t\tsocket.emit('flags.update', {\n\t\t\t\t\t\t\t\t\tflagId: flagId,\n\t\t\t\t\t\t\t\t\tdata: [\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tname: 'assignee',\n\t\t\t\t\t\t\t\t\t\t\tvalue: app.user.uid,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t}, handler);\n\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\tcase 'bulk-mark-resolved':\n\t\t\t\t\t\t\t\tsocket.emit('flags.update', {\n\t\t\t\t\t\t\t\t\tflagId: flagId,\n\t\t\t\t\t\t\t\t\tdata: [\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tname: 'state',\n\t\t\t\t\t\t\t\t\t\t\tvalue: 'resolved',\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t}, handler);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t});\n\n\t\t\t\tPromise.allSettled(promises).then(function (results) {\n\t\t\t\t\tvar fulfilled = results.filter(function (res) {\n\t\t\t\t\t\treturn res.status === 'fulfilled';\n\t\t\t\t\t}).length;\n\t\t\t\t\tvar errors = results.filter(function (res) {\n\t\t\t\t\t\treturn res.status === 'rejected';\n\t\t\t\t\t});\n\t\t\t\t\tif (fulfilled) {\n\t\t\t\t\t\tapp.alertSuccess('[[flags:bulk-success, ' + fulfilled + ']]');\n\t\t\t\t\t}\n\n\t\t\t\t\terrors.forEach(function (res) {\n\t\t\t\t\t\tapp.alertError(res.reason);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n\n\tFlags.getSelected = function () {\n\t\tvar checkboxes = document.querySelectorAll('[component=\"flags/list\"] [data-flag-id] input[type=\"checkbox\"]');\n\t\tvar payload = [];\n\t\tcheckboxes.forEach(function (el) {\n\t\t\tif (el.checked) {\n\t\t\t\tpayload.push(el.closest('[data-flag-id]').getAttribute('data-flag-id'));\n\t\t\t}\n\t\t});\n\n\t\treturn payload;\n\t};\n\n\tFlags.handleGraphs = function () {\n\t\tvar dailyCanvas = document.getElementById('flags:daily');\n\t\tvar dailyLabels = utils.getDaysArray().map(function (text, idx) {\n\t\t\treturn idx % 3 ? '' : text;\n\t\t});\n\n\t\tif (utils.isMobile()) {\n\t\t\tChart.defaults.global.tooltips.enabled = false;\n\t\t}\n\t\tvar data = {\n\t\t\t'flags:daily': {\n\t\t\t\tlabels: dailyLabels,\n\t\t\t\tdatasets: [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: '',\n\t\t\t\t\t\tbackgroundColor: 'rgba(151,187,205,0.2)',\n\t\t\t\t\t\tborderColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\tpointBackgroundColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\tpointHoverBackgroundColor: '#fff',\n\t\t\t\t\t\tpointBorderColor: '#fff',\n\t\t\t\t\t\tpointHoverBorderColor: 'rgba(151,187,205,1)',\n\t\t\t\t\t\tdata: ajaxify.data.analytics,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t};\n\n\t\tdailyCanvas.width = $(dailyCanvas).parent().width();\n\t\tnew Chart(dailyCanvas.getContext('2d'), {\n\t\t\ttype: 'line',\n\t\t\tdata: data['flags:daily'],\n\t\t\toptions: {\n\t\t\t\tresponsive: true,\n\t\t\t\tanimation: false,\n\t\t\t\tlegend: {\n\t\t\t\t\tdisplay: false,\n\t\t\t\t},\n\t\t\t\tscales: {\n\t\t\t\t\tyAxes: [{\n\t\t\t\t\t\tticks: {\n\t\t\t\t\t\t\tbeginAtZero: true,\n\t\t\t\t\t\t\tprecision: 0,\n\t\t\t\t\t\t},\n\t\t\t\t\t}],\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t};\n\n\treturn Flags;\n});\n"]}